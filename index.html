<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Asistencia - Cursos</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 95%;
            margin: auto;
        }
        /* Contenedor principal de la tabla con scroll horizontal y vertical */
        .table-container {
            max-height: 80vh; /* Permite desplazamiento vertical si la tabla es muy larga */
            overflow: auto;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        table {
            width: 100%;
            min-width: 1200px; /* Asegura el scroll horizontal en pantallas pequeñas */
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
            white-space: nowrap;
            background-color: #ffffff; /* Fondo para evitar que el contenido se muestre al hacer scroll */
        }
        th {
            background-color: #4b5563;
            color: #ffffff;
            font-weight: 600;
            vertical-align: top;
        }
        /* La fila de encabezados se mantiene fija en la parte superior */
        thead tr th {
            position: sticky;
            top: 0;
            z-index: 20;
            background-color: #4b5563; /* Fondo para que no sea transparente */
        }
        /* La celda de la esquina superior izquierda se fija en ambas direcciones */
        thead th:first-child {
            left: 0;
            z-index: 21;
            box-shadow: 2px 0 5px -2px rgba(0, 0, 0, 0.1); /* Sombra para resaltar */
        }
        /* La primera columna de datos se mantiene fija a la izquierda */
        tbody tr td:first-child {
            position: sticky;
            left: 0;
            z-index: 10;
            text-align: left;
            font-weight: bold;
            background-color: #f9fafb; /* Fondo para que no sea transparente */
            box-shadow: 2px 0 5px -2px rgba(0, 0, 0, 0.1);
        }
        tr:last-child td {
            border-bottom: none;
        }
        .alert-row {
            background-color: #fee2e2;
        }
        .tab-button {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            background-color: #4b5563;
            color: #ffffff;
        }
        .tab-button:not(.active) {
            background-color: #d1d5db;
            color: #4b5563;
        }
        .attendance-input {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
            padding: 0.25rem 0;
        }
        .attendance-input label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .message-box {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: #4CAF50;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="container max-w-screen-2xl bg-white shadow-xl rounded-xl p-4 sm:p-8 mt-4">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-gray-800">Control de Asistencia de Clases</h1>

        <!-- Tab Navigation -->
        <div class="flex justify-center mb-8">
            <button id="tab-1" class="tab-button active">CMS XX y XXI I</button>
            <button id="tab-2" class="tab-button">CMS XX y XXI II</button>
        </div>
        
        <h2 id="courseTitle" class="text-2xl font-bold text-center mb-2 text-gray-700"></h2>
        <div id="courseInfo" class="text-center text-gray-600 mb-4"></div>

        <!-- Attendance Table -->
        <div id="attendanceTableContainer" class="table-container">
            <!-- Table will be rendered here by JavaScript -->
        </div>
        
        <!-- Message box for user notifications -->
        <div id="message-box" class="hidden message-box"></div>
    </div>

    <script>
        // UI Elements
        const tableContainer = document.getElementById('attendanceTableContainer');
        const messageBox = document.getElementById('message-box');
        const courseTitle = document.getElementById('courseTitle');
        const courseInfo = document.getElementById('courseInfo');

        // Show a message to the user
        const showMessage = (text, type = 'success') => {
            messageBox.textContent = text;
            messageBox.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        };
        
        // Function to format names
        const capitalizeWords = (str) => {
            return str.toLowerCase().split(' ').map(word => {
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        };

        // Student data for each course
        const studentsCursoI = [
            "ALVARADO POLO, MARCELA", "LEAL JIMENEZ, LUIS", "MARTINEZ GUZMAN, ESTEBAN",
            "NADER ZAPATA, SHAIEL", "RODRIGUEZ GONZALEZ, JESUS", "SANTAMARIA BARRAZA, MIGUEL"
        ].map(capitalizeWords);
        const studentsCursoII = [
            "AGUDELO BALLESTEROS, DANIEL", "APARICIO HOYOS, ESTEBAN", "BATISTA MIRANDA, JHORMAN",
            "ESCOBAR DE ALBA, ANGEL", "ESPARZA MERCADO, PABLO", "QUINTERO RICARDO, SANTIAGO",
            "RODRIGUEZ LARA, NATALIA", "ROSERO SAUCEDO, THOMAS", "SUAREZ OVIEDO, CARLOS",
            "VENDRIES CORREA, SANTIAGO"
        ].map(capitalizeWords);
        
        // Specific dates for the 16 classes (omitting Oct 8th)
        const classDates = [
            "30-Jul", "06-Ago", "13-Ago", "20-Ago", "27-Ago", "03-Sep",
            "10-Sep", "17-Sep", "24-Sep", "01-Oct", "15-Oct", "22-Oct",
            "29-Oct", "05-Nov", "12-Nov", "19-Nov"
        ];

        // Global variables for the app state
        let activeCourse = 'CMS XX y XXI I';
        let attendanceData = {};

        // Course configuration
        const courseConfig = {
            'CMS XX y XXI I': {
                students: studentsCursoI,
                totalHours: 16 * 2,
                alertHours: 8,
                alertPercentage: 25,
                title: "Conceptos de música del siglo XX y XXI I",
                time: "2:30 p.m. a 4:30 p.m.",
                professor: "Juan Miguel Rios Redondo"
            },
            'CMS XX y XXI II': {
                students: studentsCursoII,
                totalHours: 16 * 2,
                alertHours: 8,
                alertPercentage: 25,
                title: "Conceptos de música del siglo XX y XXI II",
                time: "4:30 p.m. a 6:30 p.m.",
                professor: "Juan Miguel Rios Redondo"
            }
        };

        // Function to render the table
        const renderTable = (scrollPosition = { left: 0, top: 0 }) => {
            const config = courseConfig[activeCourse];
            const students = config.students;
            const data = attendanceData[activeCourse] || {};
            
            // Update course title and info
            courseTitle.textContent = config.title;
            courseInfo.innerHTML = `<p>Docente: ${config.professor}</p><p>Horario: ${config.time}</p>`;

            let tableHTML = `
                <table class="bg-white">
                    <thead>
                        <tr>
                            <th class="rounded-tl-xl">Nombre</th>
            `;

            // Add headers for each session date
            classDates.forEach(date => {
                tableHTML += `<th class="text-center">${date}</th>`;
            });

            tableHTML += `
                            <th class="bg-blue-600 text-white">Total Hrs Ausencia</th>
                            <th class="bg-blue-600 text-white">% de Ausencia</th>
                            <th class="bg-blue-600 text-white rounded-tr-xl">
                                <div style="white-space: normal;">% de Asistencia</div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Add rows for each student
            students.forEach(student => {
                let totalAbsenceHours = 0;
                let isAlert = false;
                let rowContent = '';

                // Get attendance status for each session
                classDates.forEach(date => {
                    const studentData = data[date] && data[date][student] ? data[date][student] : { present: true, tardy: false, absent: false };
                    
                    let sessionAbsenceHours = 0;
                    if (studentData.absent) {
                        sessionAbsenceHours = 2; // 2 hours for full absence
                    } else if (studentData.tardy) {
                        sessionAbsenceHours = 1; // 1 hour for tardy/early leave
                    }
                    totalAbsenceHours += sessionAbsenceHours;

                    rowContent += `
                        <td>
                            <div class="attendance-input">
                                <label>
                                    <input type="checkbox" name="${student}-${date}"
                                        onchange="updateAttendance('${activeCourse}', '${date}', '${student}', 'present', this.checked)"
                                        ${studentData.present ? 'checked' : ''} class="form-checkbox h-4 w-4 text-green-500 rounded focus:ring-green-400"> Presente
                                </label>
                                <label>
                                    <input type="checkbox" name="${student}-${date}"
                                        onchange="updateAttendance('${activeCourse}', '${date}', '${student}', 'tardy', this.checked)"
                                        ${studentData.tardy ? 'checked' : ''} class="form-checkbox h-4 w-4 text-yellow-500 rounded focus:ring-yellow-400"> Tarde (1h)
                                </label>
                                <label>
                                    <input type="checkbox" name="${student}-${date}"
                                        onchange="updateAttendance('${activeCourse}', '${date}', '${student}', 'absent', this.checked)"
                                        ${studentData.absent ? 'checked' : ''} class="form-checkbox h-4 w-4 text-red-500 rounded focus:ring-red-400"> Falta (2h)
                                </label>
                            </div>
                        </td>
                    `;
                });

                // Calculate percentage and check for alerts
                const percentageAbsence = config.totalHours > 0 ? ((totalAbsenceHours / config.totalHours) * 100).toFixed(2) : 0;
                const percentageAttendance = (100 - percentageAbsence).toFixed(2);
                if (totalAbsenceHours >= config.alertHours || percentageAbsence >= config.alertPercentage) {
                    isAlert = true;
                }

                tableHTML += `
                    <tr class="${isAlert ? 'alert-row' : ''}">
                        <td class="font-bold name-col">${student}</td>
                        ${rowContent}
                        <td class="font-bold">${totalAbsenceHours}</td>
                        <td class="font-bold">${percentageAbsence}%</td>
                        <td class="font-bold">${percentageAttendance}%</td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
            `;

            tableContainer.innerHTML = tableHTML;
            
            // Restore scroll position after a slight delay
            setTimeout(() => {
                tableContainer.scrollLeft = scrollPosition.left;
                tableContainer.scrollTop = scrollPosition.top;
            }, 50);
        };

        // Save data to localStorage
        const saveData = () => {
            try {
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                showMessage('Asistencia guardada automáticamente en tu navegador.');
            } catch (e) {
                console.error("Error saving to local storage: ", e);
                showMessage('Error al guardar la asistencia.', 'error');
            }
        };

        // Load data from localStorage
        const loadData = () => {
            try {
                const savedData = localStorage.getItem('attendanceData');
                if (savedData) {
                    attendanceData = JSON.parse(savedData);
                } else {
                    attendanceData = {};
                }
            } catch (e) {
                console.error("Error loading from local storage: ", e);
                attendanceData = {};
            }
            renderTable();
        };

        // Update attendance data
        const updateAttendance = (course, date, student, type, checked) => {
            // Get the current scroll position before re-rendering
            const scrollPosition = {
                left: tableContainer.scrollLeft,
                top: tableContainer.scrollTop
            };
            
            // Ensure data structure exists
            const currentData = attendanceData[course] || {};
            const dateData = currentData[date] || {};
            const studentData = dateData[student] || { present: true, tardy: false, absent: false };
            
            // Uncheck other options
            studentData.present = false;
            studentData.tardy = false;
            studentData.absent = false;
            
            // Set the new status based on the checked checkbox
            if (checked) {
                studentData[type] = true;
            } else {
                studentData.present = true; // Default to present if nothing is checked
            }

            // Update the local state
            dateData[student] = studentData;
            currentData[date] = dateData;
            attendanceData[course] = currentData;
            
            // Save the updated data
            saveData();
            // Re-render table and pass the scroll position to restore it
            renderTable(scrollPosition);
        };

        window.updateAttendance = updateAttendance;

        // Switch between courses
        const switchCourse = (course) => {
            activeCourse = course;
            document.getElementById('tab-1').classList.toggle('active', course === 'CMS XX y XXI I');
            document.getElementById('tab-2').classList.toggle('active', course === 'CMS XX y XXI II');
            renderTable();
        };

        // Tab functionality
        document.getElementById('tab-1').addEventListener('click', () => switchCourse('CMS XX y XXI I'));
        document.getElementById('tab-2').addEventListener('click', () => switchCourse('CMS XX y XXI II'));

        // Initial load
        window.onload = loadData;
    </script>
</body>
</html>


