<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker: H√°bitos At√≥micos</title>
    
    <!-- Tailwind CSS Configuraci√≥n para Modo Oscuro -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', // Un tono m√°s oscuro espec√≠fico
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Confetti para celebraciones -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* Estilos personalizados para animaciones suaves */
        .transition-width {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Checkbox Personalizado */
        .check-btn:hover .icon-circle { opacity: 0; }
        .check-btn:hover .icon-check { opacity: 0.5; }
        .check-btn.completed .icon-circle { display: none; }
        .check-btn.completed .icon-check { display: block; opacity: 1; color: #22c55e; transform: scale(1.1); }
        .check-btn:not(.completed) .icon-check { display: none; }

        /* Item "Siguiente" */
        .next-up {
            border-left: 4px solid #f59e0b; /* Amber-500 */
            background-color: #fffbeb; /* Amber-50 (Light) */
        }
        /* Dark Mode overrides para Next Up */
        .dark .next-up {
            background-color: #451a03; /* Amber-950/30 aprox */
            border-left-color: #d97706;
        }

        .next-up .next-badge { display: inline-flex; }
        .item-row:not(.next-up) .next-badge { display: none; }

        /* Modal Transiciones */
        #video-modal { transition: opacity 0.3s ease-in-out; }
        #video-modal.hidden { display: none; opacity: 0; pointer-events: none; }
        #video-modal:not(.hidden) { display: flex; opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans pb-12 transition-colors duration-300 dark:bg-slate-950 dark:text-slate-200">

    <!-- Header Fijo -->
    <div class="sticky top-0 z-10 bg-white shadow-sm border-b border-slate-200 dark:bg-slate-900 dark:border-slate-800 transition-colors duration-300">
        <div class="max-w-3xl mx-auto px-4 py-4">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-3 gap-3">
                <div class="flex items-center gap-3">
                    <h1 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                        <i data-lucide="book-open" class="w-6 h-6 text-amber-500"></i>
                        H√°bitos At√≥micos
                    </h1>
                    <!-- Bot√≥n Modo Oscuro -->
                    <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 transition-colors" title="Cambiar tema">
                        <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                        <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                    </button>
                </div>

                <div class="flex items-center gap-3 text-sm">
                     <div class="flex flex-col items-end">
                        <span id="progress-text" class="font-bold text-amber-600 dark:text-amber-500">0% Completado</span>
                        <span id="time-text" class="text-xs text-slate-500 dark:text-slate-400 font-mono">0h 0m / 8h 11m</span>
                     </div>
                </div>
            </div>
            
            <!-- Barra de Progreso -->
            <div class="w-full bg-slate-200 dark:bg-slate-800 rounded-full h-2.5 overflow-hidden">
                <div id="progress-bar" class="bg-amber-500 h-2.5 rounded-full transition-width relative" style="width: 0%">
                    <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-3xl mx-auto px-4 mt-6">
        
        <!-- Quote Card (Nueva Funcionalidad) -->
        <div id="quote-card" class="bg-amber-50 dark:bg-slate-900 border-l-4 border-amber-400 p-4 mb-8 rounded-r-xl shadow-sm fade-in flex gap-3 items-start">
            <i data-lucide="quote" class="w-8 h-8 text-amber-300 flex-shrink-0 mt-1"></i>
            <div>
                <p id="quote-text" class="text-slate-700 dark:text-slate-300 italic text-sm font-medium mb-1">
                    "Cargando frase inspiradora..."
                </p>
                <p class="text-slate-400 dark:text-slate-500 text-xs">‚Äî James Clear</p>
            </div>
        </div>

        <!-- Intro Card -->
        <div class="bg-white dark:bg-slate-900 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800 mb-8 fade-in transition-colors duration-300">
            <h2 class="text-lg font-semibold mb-2 text-slate-800 dark:text-white">Tu sistema de aprendizaje</h2>
            <p class="text-slate-600 dark:text-slate-400 text-sm leading-relaxed">
                Haz clic en <span class="inline-flex items-center bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300 rounded px-1.5 py-0.5 text-xs font-bold mx-1"><i data-lucide="play" class="w-3 h-3 mr-1"></i> Ver</span> para reproducir.
                Al completar una secci√≥n, marca el c√≠rculo para recibir tu dosis de dopamina üéâ.
            </p>
        </div>

        <!-- Contenedor de la lista -->
        <div id="app-container" class="space-y-8 pb-8">
            <!-- El contenido se generar√° aqu√≠ con JavaScript -->
        </div>

        <!-- Bot√≥n Reset y Footer -->
        <div class="mt-8 mb-12 text-center fade-in border-t border-slate-200 dark:border-slate-800 pt-8">
            <button onclick="resetProgress()" class="text-xs text-slate-400 hover:text-red-500 underline transition-colors mb-4 flex items-center justify-center gap-1 mx-auto">
                <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reiniciar todo el progreso
            </button>
            <p class="text-slate-400 dark:text-slate-600 text-xs">Una mejora del 1% cada d√≠a.</p>
        </div>
    </div>

    <!-- Modal de Video -->
    <div id="video-modal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/90 p-4 backdrop-blur-sm">
        <div class="bg-black w-full max-w-4xl rounded-xl overflow-hidden shadow-2xl relative flex flex-col border border-slate-800">
            <!-- Header del Modal -->
            <div class="flex items-center justify-between p-3 bg-slate-900 text-white border-b border-slate-800">
                <span class="text-sm font-medium flex items-center gap-2">
                    <i data-lucide="youtube" class="w-4 h-4 text-red-500"></i> Reproduciendo Cap√≠tulo
                </span>
                <button onclick="closeVideo()" class="text-slate-400 hover:text-white transition-colors p-1 hover:bg-white/10 rounded-full">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Contenedor del Iframe (Aspect Ratio 16:9) -->
            <div class="relative w-full aspect-video bg-black">
                <iframe id="youtube-iframe" 
                        class="absolute top-0 left-0 w-full h-full"
                        src="" 
                        title="YouTube video player" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                        allowfullscreen>
                </iframe>
            </div>
            <div class="p-2 bg-slate-900 text-center text-xs text-slate-500">
                El video se pausar√° autom√°ticamente al terminar la secci√≥n.
            </div>
        </div>
    </div>

    <!-- L√≥gica de la Aplicaci√≥n -->
    <script>
        // --- Datos del libro ---
        const sections = [
            {
                title: "Introducci√≥n",
                items: [
                    { id: 0, title: "Introducci√≥n: Mi historia", start: "00:00:00", end: "00:26:50", seconds: 0 }
                ]
            },
            {
                title: "Principios Fundamentales",
                items: [
                    { id: 1, title: "1. El sorprendente poder de los h√°bitos at√≥micos", start: "00:27:05", end: "01:05:30", seconds: 1625 },
                    { id: 2, title: "2. La manera en que tus h√°bitos moldean tu identidad", start: "01:05:30", end: "01:36:11", seconds: 3930 },
                    { id: 3, title: "3. C√≥mo construir mejores h√°bitos en 4 pasos", start: "01:36:11", end: "02:07:09", seconds: 5771 }
                ]
            },
            {
                title: "Primera Ley: Hacerlo Obvio",
                items: [
                    { id: 4, title: "4. El hombre que no se ve√≠a bien", start: "02:07:09", end: "02:26:54", seconds: 7629 },
                    { id: 5, title: "5. La mejor manera de comenzar un nuevo h√°bito", start: "02:26:54", end: "02:50:02", seconds: 8814 },
                    { id: 6, title: "6. La motivaci√≥n est√° sobrevalorada", start: "02:50:02", end: "03:12:44", seconds: 10202 },
                    { id: 7, title: "7. El secreto del autocontrol", start: "03:12:44", end: "03:23:53", seconds: 11564 }
                ]
            },
            {
                title: "Segunda Ley: Hacerlo Atractivo",
                items: [
                    { id: 8, title: "8. C√≥mo lograr que un h√°bito sea irresistible", start: "03:24:07", end: "03:49:54", seconds: 12247 },
                    { id: 9, title: "9. El papel de la familia y los amigos", start: "03:49:54", end: "04:14:32", seconds: 13794 },
                    { id: 10, title: "10. C√≥mo localizar y arreglar malos h√°bitos", start: "04:14:32", end: "04:36:52", seconds: 15272 }
                ]
            },
            {
                title: "Tercera Ley: Hacerlo Sencillo",
                items: [
                    { id: 11, title: "11. Avanza despacio, pero no des marcha atr√°s", start: "04:37:06", end: "04:49:33", seconds: 16626 },
                    { id: 12, title: "12. La ley del menor esfuerzo", start: "04:49:33", end: "05:13:20", seconds: 17373 },
                    { id: 13, title: "13. C√≥mo dejar de postergar (Regla de 2 min)", start: "05:13:20", end: "05:30:02", seconds: 18800 },
                    { id: 14, title: "14. C√≥mo hacer inevitables los buenos h√°bitos", start: "05:30:02", end: "05:47:05", seconds: 19802 }
                ]
            },
            {
                title: "Cuarta Ley: Hacerlo Satisfactorio",
                items: [
                    { id: 15, title: "15. La regla cardinal del cambio de conducta", start: "05:47:18", end: "06:14:37", seconds: 20838 },
                    { id: 16, title: "16. C√≥mo mantener los buenos h√°bitos todos los d√≠as", start: "06:14:37", end: "06:39:28", seconds: 22477 },
                    { id: 17, title: "17. C√≥mo un socio corresponsable cambia todo", start: "06:39:28", end: "06:54:29", seconds: 23968 }
                ]
            },
            {
                title: "T√°cticas Avanzadas",
                items: [
                    { id: 18, title: "18. La verdad acerca del talento", start: "06:54:43", end: "07:23:04", seconds: 24883 },
                    { id: 19, title: "19. La regla de Ricitos de Oro", start: "07:23:04", end: "07:41:26", seconds: 26584 },
                    { id: 20, title: "20. El inconveniente de crear buenos h√°bitos", start: "07:41:26", end: "08:06:22", seconds: 27686 }
                ]
            },
            {
                title: "Conclusi√≥n",
                items: [
                    { id: 21, title: "Conclusi√≥n: El secreto para resultados que duren", start: "08:06:22", end: "08:11:42", seconds: 29182 }
                ]
            }
        ];

        // --- Citas del libro ---
        const quotes = [
            "No te elevas al nivel de tus metas. Caes al nivel de tus sistemas.",
            "Los h√°bitos son el inter√©s compuesto de la superaci√≥n personal.",
            "Cada acci√≥n que tomas es un voto por el tipo de persona en la que deseas convertirte.",
            "Debes estar mucho m√°s interesado en tu trayectoria actual que en tus resultados actuales.",
            "La forma m√°s efectiva de cambiar tus h√°bitos es no enfocarte en lo que quieres lograr, sino en qui√©n quieres llegar a ser.",
            "El ambiente es la mano invisible que moldea el comportamiento humano.",
            "Hazlo obvio. Hazlo atractivo. Hazlo sencillo. Hazlo satisfactorio.",
            "El √©xito es el producto de los h√°bitos diarios, no de transformaciones de una vez en la vida.",
            "Un 1% mejor cada d√≠a, termina siendo 37 veces mejor al final del a√±o."
        ];

        // --- Funciones de Tiempo ---
        function parseTimeStr(timeStr) {
            const parts = timeStr.split(':').map(Number);
            if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
            if (parts.length === 2) return parts[0] * 60 + parts[1];
            return 0;
        }

        function formatDuration(totalSeconds) {
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            if (h > 0) return `${h}h ${m}m`;
            return `${m} min`;
        }

        function getItemDuration(item) {
            const startSec = parseTimeStr(item.start);
            const endSec = parseTimeStr(item.end);
            return endSec - startSec;
        }

        // --- Estado y L√≥gica Principal ---
        let completed = JSON.parse(localStorage.getItem('atomicHabitsProgressHTML')) || [];
        
        // Calcular estadisticas iniciales
        let totalBookSeconds = 0;
        sections.forEach(s => s.items.forEach(i => totalBookSeconds += getItemDuration(i)));

        function toggleComplete(id, event) {
            // Detener propagaci√≥n para evitar que click en fila dispare l√≥gica incorrecta si la hubiera
            if(event) event.stopPropagation();

            const isCompleting = !completed.includes(id);

            if (completed.includes(id)) {
                completed = completed.filter(item => item !== id);
            } else {
                completed.push(id);
            }
            saveAndRender();

            // Lanzar confeti solo si estamos completando
            if (isCompleting) {
                triggerConfetti();
            }
        }

        function resetProgress() {
            if(confirm("¬øEst√°s seguro de que quieres borrar todo tu progreso?")) {
                completed = [];
                saveAndRender();
            }
        }

        // --- Citas ---
        function loadRandomQuote() {
            const index = Math.floor(Math.random() * quotes.length);
            document.getElementById('quote-text').innerText = `"${quotes[index]}"`;
        }

        // --- Modo Oscuro ---
        function initDarkMode() {
            const isDark = localStorage.getItem('theme') === 'dark' || 
                          (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            updateTheme(isDark);
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            updateTheme(!isDark);
        }

        function updateTheme(isDark) {
            const html = document.documentElement;
            if (isDark) {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        }

        // --- Confetti FX ---
        function triggerConfetti() {
            var count = 200;
            var defaults = {
                origin: { y: 0.7 }
            };

            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(count * particleRatio)
                }));
            }

            fire(0.25, { spread: 26, startVelocity: 55 });
            fire(0.2, { spread: 60 });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
            fire(0.1, { spread: 120, startVelocity: 45 });
        }

        // --- Video Modal ---
        function openVideo(startSeconds, endSeconds) {
            const modal = document.getElementById('video-modal');
            const iframe = document.getElementById('youtube-iframe');
            
            const videoId = "CgGiyfv7Xpc";
            const embedUrl = `https://www.youtube.com/embed/${videoId}?start=${startSeconds}&end=${endSeconds}&autoplay=1&rel=0`;
            
            iframe.src = embedUrl;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeVideo() {
            const modal = document.getElementById('video-modal');
            const iframe = document.getElementById('youtube-iframe');
            iframe.src = "";
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape") closeVideo();
        });

        document.getElementById('video-modal').addEventListener('click', (e) => {
            if (e.target.id === 'video-modal') closeVideo();
        });

        // --- Renderizado ---
        function saveAndRender() {
            localStorage.setItem('atomicHabitsProgressHTML', JSON.stringify(completed));
            updateProgressUI();
            renderList();
        }

        function updateProgressUI() {
            const totalItems = sections.reduce((acc, section) => acc + section.items.length, 0);
            const percentage = Math.round((completed.length / totalItems) * 100);
            
            let listenedSeconds = 0;
            sections.forEach(section => {
                section.items.forEach(item => {
                    if (completed.includes(item.id)) {
                        listenedSeconds += getItemDuration(item);
                    }
                });
            });

            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').innerText = `${percentage}% Completado`;
            document.getElementById('time-text').innerText = `${formatDuration(listenedSeconds)} / ${formatDuration(totalBookSeconds)}`;
        }

        function renderList() {
            const container = document.getElementById('app-container');
            container.innerHTML = '';

            let firstUncompletedFound = false;

            sections.forEach((section, index) => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'fade-in';
                
                const header = document.createElement('h3');
                header.className = 'text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3 ml-1';
                header.innerText = section.title;
                sectionEl.appendChild(header);

                const listContainer = document.createElement('div');
                listContainer.className = 'bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors duration-300';

                section.items.forEach(item => {
                    const isCompleted = completed.includes(item.id);
                    const durationStr = formatDuration(getItemDuration(item));
                    const endSeconds = parseTimeStr(item.end);

                    let isNextUp = false;
                    if (!isCompleted && !firstUncompletedFound) {
                        isNextUp = true;
                        firstUncompletedFound = true;
                    }

                    const itemEl = document.createElement('div');
                    itemEl.className = `item-row group flex items-center justify-between p-4 border-b border-slate-100 dark:border-slate-800 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors 
                        ${isCompleted ? 'bg-slate-50 dark:bg-slate-950/50' : ''} 
                        ${isNextUp ? 'next-up' : ''}`;
                    
                    itemEl.innerHTML = `
                        <div class="flex items-center gap-4 flex-1 cursor-pointer" onclick="toggleComplete(${item.id}, event)">
                            <button class="check-btn flex-shrink-0 transition-all duration-200 text-slate-300 dark:text-slate-600 hover:text-slate-400 dark:hover:text-slate-500 ${isCompleted ? 'completed' : ''}">
                                <i data-lucide="circle" class="w-6 h-6 icon-circle"></i>
                                <i data-lucide="check-circle" class="w-6 h-6 icon-check"></i>
                            </button>
                            
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="next-badge text-[10px] font-bold uppercase tracking-wide text-amber-600 dark:text-amber-300 bg-amber-100 dark:bg-amber-900/40 px-1.5 py-0.5 rounded">Siguiente</span>
                                    <p class="font-medium text-base transition-colors leading-tight ${isCompleted ? 'text-slate-400 dark:text-slate-600 line-through decoration-slate-300 dark:decoration-slate-700' : 'text-slate-800 dark:text-slate-200'}">
                                        ${item.title}
                                    </p>
                                </div>
                                <div class="flex flex-wrap items-center gap-x-3 gap-y-1 mt-1 text-xs font-mono text-slate-500 dark:text-slate-500">
                                    <span class="flex items-center gap-1 bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded">
                                        <i data-lucide="clock" class="w-3 h-3"></i> ${durationStr}
                                    </span>
                                    <span>${item.start} - ${item.end}</span>
                                </div>
                            </div>
                        </div>

                        <button onclick="openVideo(${item.seconds}, ${endSeconds}); event.stopPropagation();" 
                                class="ml-4 p-2 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded-full hover:bg-amber-500 dark:hover:bg-amber-600 hover:text-white transition-all shadow-sm group-hover:shadow-md flex items-center gap-2"
                                title="Ver en YouTube">
                            <i data-lucide="play" class="w-4 h-4 fill-current"></i>
                            <span class="text-xs font-bold hidden sm:inline">Ver</span>
                        </button>
                    `;
                    listContainer.appendChild(itemEl);
                });

                sectionEl.appendChild(listContainer);
                container.appendChild(sectionEl);
            });
            
            lucide.createIcons();
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            initDarkMode();
            loadRandomQuote();
            saveAndRender();
        });

    </script>
</body>
</html>
