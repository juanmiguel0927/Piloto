<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audiolibro </title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' },
                        amber: { 450: '#f59e0b' }
                    }
                }
            }
        }
    </script>
    
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        .transition-width { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .check-btn:hover .icon-circle { opacity: 0; }
        .check-btn:hover .icon-check { opacity: 0.5; }
        .check-btn.completed .icon-circle { display: none; }
        .check-btn.completed .icon-check { display: block; opacity: 1; color: #22c55e; transform: scale(1.1); }
        .check-btn:not(.completed) .icon-check { display: none; }

        .next-up { border-left: 4px solid #f59e0b; background-color: #fffbeb; }
        .dark .next-up { background-color: #451a03; border-left-color: #d97706; }
        .next-up .next-badge { display: inline-flex; }
        .item-row:not(.next-up) .next-badge { display: none; }

        .modal-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-overlay.hidden { display: none; opacity: 0; pointer-events: none; }
        .modal-overlay:not(.hidden) { display: flex; opacity: 1; pointer-events: auto; }

        .tab-btn { position: relative; }
        .tab-btn.active { color: #f59e0b; font-weight: 600; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background-color: #f59e0b; }
        .tab-btn:not(.active) { color: #64748b; }
        .dark .tab-btn:not(.active) { color: #94a3b8; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .chart-bar { transition: height 1s ease-out; }
        .pie-chart { background: conic-gradient(var(--pie-gradient)); border-radius: 50%; }

        .heatmap-cell { width: 10px; height: 10px; border-radius: 2px; }
        @media (min-width: 640px) { .heatmap-cell { width: 12px; height: 12px; } }
        .level-0 { background-color: #e2e8f0; }
        .dark .level-0 { background-color: #1e293b; }
        .level-1 { background-color: #fde68a; }
        .level-2 { background-color: #fbbf24; }
        .level-3 { background-color: #f59e0b; }
        .level-4 { background-color: #b45309; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans pb-12 transition-colors duration-300 dark:bg-slate-950 dark:text-slate-200">

    <!-- Header Fijo -->
    <div class="sticky top-0 z-20 bg-white shadow-sm border-b border-slate-200 dark:bg-slate-900 dark:border-slate-800 transition-colors duration-300">
        <div class="max-w-4xl mx-auto px-4 pt-4 pb-0">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 gap-3">
                <div class="flex items-center gap-3">
                    <h1 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                        <i data-lucide="book-open" class="w-6 h-6 text-amber-500"></i>
                        Audiolibro
                    </h1>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 transition-colors">
                        <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                        <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                    </button>
                </div>

                <div class="flex items-center gap-2 text-sm">
                    <div id="pomodoro-widget" class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 px-3 py-1.5 rounded-lg border dark:border-slate-700">
                        <i data-lucide="timer" class="w-4 h-4 text-amber-500"></i>
                        <span id="pomo-timer" class="font-mono font-bold w-12 text-center">25:00</span>
                        <button onclick="togglePomodoro()" id="pomo-btn" class="hover:text-amber-600"><i data-lucide="play" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="w-full bg-slate-200 dark:bg-slate-800 rounded-full h-1.5 overflow-hidden mb-4">
                <div id="global-progress-bar" class="bg-amber-500 h-1.5 rounded-full transition-width" style="width: 0%"></div>
            </div>

            <div class="flex space-x-6 overflow-x-auto scrollbar-hide">
                <button onclick="switchView('library')" id="tab-library" class="tab-btn pb-3 px-1 text-sm whitespace-nowrap transition-colors active">Biblioteca</button>
                <button onclick="switchView('notes')" id="tab-notes" class="tab-btn pb-3 px-1 text-sm whitespace-nowrap transition-colors">Notas y Favoritos</button>
                <button onclick="switchView('stats')" id="tab-stats" class="tab-btn pb-3 px-1 text-sm whitespace-nowrap transition-colors">Balance & Constancia</button>
            </div>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="max-w-4xl mx-auto px-4 mt-6">

        <!-- VISTA: BIBLIOTECA -->
        <div id="view-library" class="fade-in">
            <div class="flex space-x-2 overflow-x-auto scrollbar-hide mb-4 pb-1">
                <button onclick="switchBook('habitosAtomicos')" id="book-btn-habitosAtomicos" class="book-select-btn px-4 py-2 rounded-full text-xs font-medium transition-all">Hábitos Atómicos</button>
                <button onclick="switchBook('cosasBuenas')" id="book-btn-cosasBuenas" class="book-select-btn px-4 py-2 rounded-full text-xs font-medium transition-all">Cosas Buenas</button>
                <button onclick="switchBook('sieteHabitos')" id="book-btn-sieteHabitos" class="book-select-btn px-4 py-2 rounded-full text-xs font-medium transition-all">7 Hábitos</button>
                <button onclick="switchBook('personaVitamina')" id="book-btn-personaVitamina" class="book-select-btn px-4 py-2 rounded-full text-xs font-medium transition-all">Persona Vitamina</button>
                <button onclick="switchBook('pensarDemasiado')" id="book-btn-pensarDemasiado" class="book-select-btn px-4 py-2 rounded-full text-xs font-medium transition-all">Dejar de Pensar</button>
            </div>

            <div class="relative mb-6">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                <input type="text" id="chapter-search" oninput="renderLibraryList()" placeholder="Buscar capítulo o tema..." class="w-full pl-10 pr-4 py-2.5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl text-sm outline-none transition-all shadow-sm">
            </div>

            <div id="quote-card" class="bg-amber-50 dark:bg-slate-900 border-l-4 border-amber-400 p-4 mb-6 rounded-r-xl shadow-sm flex gap-3 items-start">
                <i data-lucide="quote" class="w-8 h-8 text-amber-300 flex-shrink-0 mt-1"></i>
                <div>
                    <p id="quote-text" class="text-slate-700 dark:text-slate-300 italic text-sm font-medium mb-1">Cargando...</p>
                    <p id="quote-author" class="text-slate-400 dark:text-slate-500 text-xs"></p>
                </div>
            </div>

            <div class="flex items-end justify-between mb-4 px-1">
                <div>
                    <h2 id="book-title-display" class="text-xl font-bold text-slate-800 dark:text-white leading-tight"></h2>
                    <p id="book-author-display" class="text-sm text-amber-600 dark:text-amber-500"></p>
                </div>
                <div class="text-right">
                    <span id="book-progress-text" class="text-2xl font-bold text-slate-700 dark:text-slate-200">0%</span>
                    <p id="book-time-text" class="text-xs text-slate-400 font-mono">0h / 0h</p>
                </div>
            </div>

            <div id="app-container" class="space-y-6 pb-8"></div>
            
            <!-- PLAN DE ACCIÓN PERSONAL DETALLADO -->
            <div class="mt-8 p-6 bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800">
                <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2 mb-4 text-lg">
                    <i data-lucide="zap" class="w-5 h-5 text-amber-500"></i> Plan de Acción Personal
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-slate-600 dark:text-slate-400 text-xs leading-relaxed">
                    <div class="p-3 bg-blue-50/50 dark:bg-slate-850 rounded-lg border border-blue-100 dark:border-slate-800">
                        <p class="font-black text-blue-700 dark:text-blue-400 uppercase mb-1">1. Intención clara</p>
                        <p>No digas "voy a leer". Di: "Yo leeré 5 min a las 8 AM en el sofá". Sé ultra específico.</p>
                    </div>
                    <div class="p-3 bg-green-50/50 dark:bg-slate-850 rounded-lg border border-green-100 dark:border-slate-800">
                        <p class="font-black text-green-700 dark:text-green-400 uppercase mb-1">2. Regla de los 2 Min</p>
                        <p>Simplifica el hábito hasta que tome menos de 2 minutos. Hazlo ridículamente fácil.</p>
                    </div>
                    <div class="p-3 bg-purple-50/50 dark:bg-slate-850 rounded-lg border border-purple-100 dark:border-slate-800">
                        <p class="font-black text-purple-700 dark:text-purple-400 uppercase mb-1">3. Entorno Obvio</p>
                        <p>Diseña tu ambiente. Deja el audiolibro listo o pon el disparador del hábito a la vista.</p>
                    </div>
                </div>

                <div id="action-plan-list" class="space-y-3"></div>
                <div class="mt-6 flex gap-2">
                    <input type="text" id="new-action-input" class="flex-1 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-amber-500 shadow-inner" placeholder="Escribe tu próximo paso atómico...">
                    <button onclick="addActionItem()" class="bg-amber-500 hover:bg-amber-600 text-white px-5 py-2.5 rounded-lg text-sm font-bold transition-all shadow-md active:scale-95">Añadir</button>
                </div>
            </div>

             <div class="mt-12 mb-12 text-center border-t border-slate-200 dark:border-slate-800 pt-8">
                <button onclick="resetCurrentBook()" class="group text-xs text-slate-400 hover:text-red-500 transition-colors mb-4 flex items-center justify-center gap-1 mx-auto font-bold tracking-tight">
                    <i data-lucide="rotate-ccw" class="w-3 h-3 group-hover:rotate-[-45deg] transition-transform"></i> REINICIAR PROGRESO DEL LIBRO
                </button>
            </div>
        </div>

        <!-- VISTA: CENTRO DE REFLEXIÓN -->
        <div id="view-notes" class="hidden fade-in space-y-6">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-xl font-bold text-slate-800 dark:text-white leading-tight">Notas y Favoritos</h2>
                <div class="flex gap-2">
                    <button onclick="renderAllNotes(true)" class="text-xs bg-white dark:bg-slate-800 border dark:border-slate-700 px-3 py-1.5 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50">Solo Favoritos</button>
                    <button onclick="window.print()" class="text-xs bg-amber-500 text-white px-3 py-1.5 rounded-lg font-bold shadow-sm">Exportar</button>
                </div>
            </div>
            <div id="all-notes-container" class="space-y-4 pb-8"></div>
        </div>

        <!-- VISTA: ESTADÍSTICAS -->
        <div id="view-stats" class="hidden fade-in space-y-8">
            <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm text-center">
                <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-4 flex items-center gap-2 justify-center">
                    <i data-lucide="calendar-check" class="w-4 h-4 text-green-500"></i> Historial de Consistencia (90 días)
                </h3>
                <div id="streak-heatmap" class="flex flex-wrap gap-1 justify-center"></div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800 shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Hoy</p>
                    <p id="stat-today" class="text-2xl font-bold text-blue-500">0m</p>
                </div>
                <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800 shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Racha</p>
                    <p id="stat-streak" class="text-2xl font-bold text-orange-500">0 d</p>
                </div>
                <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800 shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Total</p>
                    <p id="stat-total-time" class="text-2xl font-bold dark:text-white">0h</p>
                </div>
                <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800 shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Nivel</p>
                    <p id="stat-level" class="text-lg font-bold text-amber-500">Novato</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border dark:border-slate-800 shadow-sm flex flex-col">
                    <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-6 flex items-center gap-2"><i data-lucide="pie-chart" class="w-4 h-4"></i> Distribución</h3>
                    <div class="flex items-center justify-center gap-6 flex-1">
                        <div id="distribution-pie" class="pie-chart w-32 h-32 shadow-inner" style="--pie-gradient: #e2e8f0 0% 100%;"></div>
                        <div id="distribution-legend" class="text-xs space-y-2 flex-1 text-left"></div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border dark:border-slate-800 shadow-sm flex flex-col">
                    <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-6 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4"></i> Últimos 7 días</h3>
                    <div id="weekly-chart" class="flex items-end justify-between h-32 gap-2 mt-auto"></div>
                </div>
            </div>

            <div class="text-center pb-8 flex flex-col items-center gap-3">
                <div class="flex gap-4">
                    <button onclick="exportData()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-lg text-xs font-medium"><i data-lucide="download" class="w-4 h-4"></i> Exportar</button>
                    <button onclick="triggerImport()" class="flex items-center gap-2 px-4 py-2 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded-lg text-xs font-medium"><i data-lucide="upload" class="w-4 h-4"></i> Importar</button>
                </div>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="handleFileImport(event)">
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div id="video-modal" class="modal-overlay hidden fixed inset-0 z-50 items-center justify-center bg-black/90 p-4 backdrop-blur-sm">
        <div class="bg-black w-full max-w-4xl rounded-xl overflow-hidden shadow-2xl relative flex flex-col border border-slate-800">
            <div class="flex items-center justify-between p-3 bg-slate-900 text-white border-b border-slate-800">
                <div class="flex items-center gap-3">
                    <span class="text-sm font-medium flex items-center gap-2 font-bold"><i data-lucide="youtube" class="w-4 h-4 text-red-500"></i> REPRODUCIENDO</span>
                    <div class="px-2 py-0.5 bg-amber-500 rounded text-[10px] font-black flex items-center gap-1 shadow-sm text-slate-900 uppercase">
                        <i data-lucide="clock" class="w-3 h-3 text-slate-900"></i> Resta: <span id="playback-countdown">00:00</span>
                    </div>
                </div>
                <button onclick="closeVideo()" class="text-slate-400 hover:text-white p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="relative w-full aspect-video"><iframe id="youtube-iframe" class="absolute inset-0 w-full h-full" src="" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
        </div>
    </div>

    <div id="notes-modal" class="modal-overlay hidden fixed inset-0 z-50 items-center justify-center bg-black/50 p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-xl shadow-2xl flex flex-col border dark:border-slate-800">
            <div class="p-4 border-b dark:border-slate-800 flex justify-between items-center"><h3 class="font-bold dark:text-white flex items-center gap-2"><i data-lucide="pen-tool" class="w-4 h-4 text-amber-500"></i> Notas del capítulo</h3><button onclick="closeNotes()"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="p-4"><p id="note-chapter-title" class="text-xs text-slate-500 mb-2 font-bold uppercase leading-tight"></p><textarea id="note-textarea" class="w-full h-40 p-3 rounded-lg bg-slate-50 dark:bg-slate-950 border dark:border-slate-800 text-sm outline-none focus:ring-2 focus:ring-amber-500 resize-none shadow-inner" placeholder="¿Qué aprendiste hoy?"></textarea></div>
            <div class="p-4 border-t dark:border-slate-800 flex justify-end"><button onclick="saveNote()" class="px-5 py-2 bg-amber-500 text-white rounded-lg text-sm font-bold shadow-md">Guardar</button></div>
        </div>
    </div>

    <script>
        const library = {
            habitosAtomicos: { title: "Hábitos Atómicos", author: "James Clear", color: "#ef4444", videoId: "CgGiyfv7Xpc", quotes: ["No te elevas al nivel de tus metas. Caes al nivel de tus sistemas.", "Los hábitos son el interés compuesto de la superación personal."], sections: [
                { title: "Introducción y Fundamentos", items: [
                    { id: 0, title: "Introducción: Mi historia", start: "00:00:00", end: "00:26:50" },
                    { id: 1, title: "C1: El sorprendente poder de los hábitos atómicos", start: "00:27:05", end: "01:05:30" },
                    { id: 2, title: "C2: La manera en que tus hábitos moldean tu identidad", start: "01:05:30", end: "01:36:11" },
                    { id: 3, title: "C3: Cómo construir mejores hábitos en 4 pasos", start: "01:36:11", end: "02:07:09" }
                ]},
                { title: "Las 4 Leyes", items: [
                    { id: 4, title: "C4: El hombre que no se veía bien (1ª Ley)", start: "02:07:09", end: "02:26:54" },
                    { id: 5, title: "C5: La mejor manera de comenzar un nuevo hábito", start: "02:26:54", end: "02:50:02" },
                    { id: 6, title: "C6: La motivación está sobrevalorada", start: "02:50:02", end: "03:12:44" },
                    { id: 7, title: "C7: El secreto del autocontrol", start: "03:12:44", end: "03:23:53" },
                    { id: 8, title: "C8: Cómo lograr que un hábito sea irresistible (2ª Ley)", start: "03:24:07", end: "03:49:54" },
                    { id: 9, title: "C9: El papel de la familia y los amigos", start: "03:49:54", end: "04:14:32" },
                    { id: 10, title: "C10: Cómo localizar y arreglar malos hábitos", start: "04:14:32", end: "04:36:52" },
                    { id: 11, title: "C11: Avanza despacio, no des marcha atrás (3ª Ley)", start: "04:37:06", end: "04:49:33" },
                    { id: 12, title: "C12: La ley del menor esfuerzo", start: "04:49:33", end: "05:13:20" },
                    { id: 13, title: "C13: Cómo dejar de postergar (Regla 2 min)", start: "05:13:20", end: "05:30:02" },
                    { id: 14, title: "C14: Cómo hacer inevitables los buenos hábitos", start: "05:30:02", end: "05:47:05" },
                    { id: 15, title: "C15: Regla cardinal de cambio (4ª Ley)", start: "05:47:18", end: "06:14:37" },
                    { id: 16, title: "C16: Cómo mantener los buenos hábitos", start: "06:14:37", end: "06:39:28" },
                    { id: 17, title: "C17: Cómo un socio corresponsable cambia todo", start: "06:39:28", end: "06:54:29" }
                ]},
                { title: "Avanzado y Conclusión", items: [
                    { id: 18, title: "C18: La verdad acerca del talento", start: "06:54:43", end: "07:23:04" },
                    { id: 19, title: "C19: La regla de Ricitos de Oro", start: "07:23:04", end: "07:41:26" },
                    { id: 20, title: "C20: El inconveniente de crear buenos hábitos", start: "07:41:26", end: "08:06:22" },
                    { id: 21, title: "Conclusión final", start: "08:06:22", end: "08:11:42" }
                ]}
            ]},
            cosasBuenas: { title: "Cosas Buenas", author: "Marian Rojas Estapé", color: "#3b82f6", videoId: "UiedpTbutXg", quotes: ["La felicidad no se define, se experimenta.", "Comprender es aliviar."], sections: [
                { title: "Estructura del Libro", items: [
                    { id: 100, title: "Introducción", start: "00:00:00", end: "00:11:59" },
                    { id: 101, title: "C1: El cerebro humano y sistemas operativos", start: "00:11:59", end: "00:50:19" },
                    { id: 102, title: "C2: El antídoto al sufrimiento: el amor", start: "00:50:19", end: "01:44:16" },
                    { id: 103, title: "C3: El cortisol", start: "01:44:16", end: "02:24:57" },
                    { id: 104, title: "C4: Ni lo que pasó ni lo que vendrá", start: "02:24:57", end: "03:35:49" },
                    { id: 105, title: "C5: Vivir el momento presente", start: "03:35:49", end: "04:40:38" },
                    { id: 106, title: "C6: Las emociones y su repercusión", start: "04:40:38", end: "05:37:21" },
                    { id: 107, title: "C7: ¿Qué actitudes elevan el cortisol?", start: "05:37:21", end: "06:36:28" },
                    { id: 108, title: "C8: ¿Cómo bajar el cortisol?", start: "06:36:28", end: "07:11:47" },
                    { id: 109, title: "C9: Tu mejor versión", start: "07:11:47", end: "07:34:53" }
                ]}
            ]},
            sieteHabitos: { title: "7 Hábitos", author: "Stephen Covey", color: "#10b981", videoId: "SXaY1Bz8Ndk", quotes: ["La victoria privada precede a la victoria pública.", "Busca primero entender."], sections: [
                { title: "Parte 1: Victoria Privada", items: [
                    { id: 200, title: "Introducción: Paradigmas y Principios", start: "00:00:22", end: "00:23:24" },
                    { id: 201, title: "Panorama General de los 7 Hábitos", start: "00:23:24", end: "00:36:25" },
                    { id: 202, title: "Principios de Efectividad", start: "00:36:25", end: "01:14:16" },
                    { id: 203, title: "Efectividad y Balance P/CP", start: "01:14:16", end: "01:26:57" },
                    { id: 204, title: "La Cuenta Bancaria Emocional", start: "01:26:57", end: "01:42:48" },
                    { id: 205, title: "H1: Ser Proactivo", start: "01:42:48", end: "02:10:10" },
                    { id: 206, title: "Círculo de Influencia vs Preocupación", start: "02:10:10", end: "02:38:33" },
                    { id: 207, title: "H2: Comenzar con un Fin en Mente", start: "02:38:33", end: "03:22:04" },
                    { id: 208, title: "H3: Poner Primero lo Primero", start: "03:22:04", end: "04:01:39" }
                ]},
                { title: "Parte 2: Victoria Pública", items: [
                    { id: 209, title: "H4: Pensar Ganar-Ganar", start: "00:00:24", end: "00:51:31", videoId: "-ucQ4gG25GY" },
                    { id: 210, title: "H5: Buscar primero entender", start: "00:51:31", end: "01:35:55", videoId: "-ucQ4gG25GY" },
                    { id: 211, title: "H6: Sinergizar", start: "01:35:55", end: "02:24:05", videoId: "-ucQ4gG25GY" },
                    { id: 212, title: "H7: Afilar la Sierra", start: "02:24:05", end: "02:48:07", videoId: "-ucQ4gG25GY" },
                    { id: 213, title: "Conclusión final", start: "02:48:07", end: "03:01:50", videoId: "-ucQ4gG25GY" }
                ]}
            ]},
            personaVitamina: { title: "Persona Vitamina", author: "Marian Rojas Estapé", color: "#ec4899", videoId: "26Atrg0YyVE", quotes: ["Tus relaciones determinan tu salud.", "Abrazar reduce el cortisol."], sections: [
                { title: "Oxitocina y Apego", items: [
                    { id: 300, title: "Introducción", start: "00:00:00", end: "00:07:34" },
                    { id: 301, title: "La hormona de los abrazos", start: "00:07:34", end: "00:32:44" },
                    { id: 302, title: "Los vínculos afectivos", start: "00:32:44", end: "00:44:05" },
                    { id: 303, title: "La empatía como herramienta", start: "00:44:05", end: "00:53:56" },
                    { id: 304, title: "Diferencias: Hombres y Testosterona", start: "00:53:56", end: "01:07:05" },
                    { id: 305, title: "Diferencias: Qué sucede en mujeres", start: "01:07:05", end: "01:24:21" },
                    { id: 306, title: "Tocarse es necesario", start: "01:24:21", end: "01:33:33" },
                    { id: 307, title: "La oxitocina sorprende", start: "01:33:33", end: "01:53:23" },
                    { id: 308, title: "No es bueno estar solo", start: "01:53:23", end: "02:01:56" }
                ]},
                { title: "Relaciones y Sanación", items: [
                    { id: 309, title: "9. Qué es el apego", start: "02:01:56", end: "02:30:01" },
                    { id: 310, title: "10. Amamos como nos amaron", start: "02:30:01", end: "02:40:15" },
                    { id: 311, title: "11. La confusión en la educación", start: "02:40:15", end: "03:10:09" },
                    { id: 312, title: "12. El maltrato que más perjudica", start: "03:10:09", end: "03:54:02" },
                    { id: 313, title: "13. Cómo sanar las heridas", start: "03:54:02", end: "04:42:57" },
                    { id: 314, title: "14. El placer y el amor", start: "04:42:57", end: "05:31:17" },
                    { id: 315, title: "15. Hablemos del amor", start: "05:31:17", end: "05:51:23" }
                ]},
                { title: "Gestión de Personas", items: [
                    { id: 320, title: "20. Qué es una persona tóxica", start: "06:54:09", end: "07:05:47" },
                    { id: 321, title: "21. Identificar personas que no convienen", start: "07:05:47", end: "07:23:56" },
                    { id: 322, title: "22. Saber gestionar personas tóxicas", start: "07:23:56", end: "07:58:14" },
                    { id: 323, title: "Conclusión final", start: "07:58:14", end: "08:08:41" }
                ]}
            ]},
            pensarDemasiado: { title: "Dejar de Pensar", author: "Audiolibro Completo", color: "#8b5cf6", videoId: "AtOez0u6PvY", quotes: ["El sobrepensar es un ladrón de la tranquilidad.", "La paz mental no es un sueño, es un estado."], sections: [
                { title: "Parte 1: El Problema", items: [
                    { id: 500, title: "Introducción: Calma en un mundo ruidoso", start: "00:00:04", end: "00:03:16" },
                    { id: 501, title: "C1: El silencioso ladrón de la paz", start: "00:03:16", end: "00:13:16" },
                    { id: 502, title: "C2: El precio de la mente acelerada", start: "00:13:16", end: "00:24:08" },
                    { id: 503, title: "C3: Los orígenes del torbellino mental", start: "00:24:08", end: "00:35:00" },
                    { id: 504, title: "C4: Neurociencia de la sobrecarga cerebral", start: "00:35:00", end: "00:44:13" },
                    { id: 505, title: "C5: El ciclo vicioso del pensamiento negativo", start: "00:44:13", end: "00:54:18" }
                ]},
                { title: "Parte 2: Tácticas Mentales", items: [
                    { id: 506, title: "C6: El poder del aquí y ahora (Mindfulness)", start: "00:54:18", end: "01:08:01" },
                    { id: 507, title: "C7: Desactivando el piloto automático", start: "01:08:01", end: "01:18:50" },
                    { id: 508, title: "C8: Reestructuración cognitiva", start: "01:18:50", end: "01:29:32" },
                    { id: 509, title: "C9: El arte de la distancia cognitiva", start: "01:29:32", end: "01:36:58" },
                    { id: 510, title: "C10: La gratitud como antídoto", start: "01:36:58", end: "01:44:38" },
                    { id: 511, title: "C11: Estableciendo límites digitales", start: "01:44:38", end: "01:52:37" },
                    { id: 512, title: "C12: El arte de soltar lo incontrolable", start: "01:52:37", end: "02:00:10" }
                ]},
                { title: "Parte 3: Gestión y Sanación", items: [
                    { id: 513, title: "C13: Resolución de problemas efectiva", start: "02:00:10", end: "02:07:13" },
                    { id: 514, title: "C14: Comunicación consciente", start: "02:07:13", end: "02:14:35" },
                    { id: 515, title: "C15: La importancia del NO", start: "02:14:35", end: "02:22:03" },
                    { id: 516, title: "C16: Comprendiendo la depresión y ansiedad", start: "02:22:03", end: "02:30:52" },
                    { id: 517, title: "C17: Activación conductual", start: "02:30:52", end: "02:38:44" },
                    { id: 518, title: "C18: Desafiando el crítico interno", start: "02:38:44", end: "02:46:03" },
                    { id: 519, title: "C19: Empatía y autocompasión", start: "02:46:03", end: "02:54:15" }
                ]},
                { title: "Parte 4: Propósito y Cierre", items: [
                    { id: 520, title: "C20: Reconectando con el placer", start: "02:54:15", end: "03:01:52" },
                    { id: 521, title: "C21: Construyendo resiliencia", start: "03:01:52", end: "03:10:04" },
                    { id: 522, title: "C22: Entorno seguro", start: "03:10:04", end: "03:17:45" },
                    { id: 523, title: "C23: Hábitos de sueño", start: "03:17:45", end: "03:25:30" },
                    { id: 524, title: "C24: Nutrición mental", start: "03:25:30", end: "03:33:22" },
                    { id: 525, title: "C25: El valor de un propósito", start: "03:33:22", end: "03:41:05" },
                    { id: 526, title: "C26: Conexión social", start: "03:41:05", end: "03:48:40" },
                    { id: 527, title: "C27: Mente creativa", start: "03:48:40", end: "03:55:10" },
                    { id: 528, title: "C28: Disciplina vs Libertad", start: "03:55:10", end: "04:02:20" },
                    { id: 529, title: "C29: Perspectiva a largo plazo", start: "04:02:20", end: "04:09:13" },
                    { id: 530, title: "C30: Tu plan de compromiso", start: "04:09:13", end: "04:16:41" }
                ]}
            ]}
        };

        let currentBookId = localStorage.getItem('activeBookId') || 'habitosAtomicos';
        let listeningHistory = JSON.parse(localStorage.getItem('listeningHistory')) || []; 
        let chapterNotes = JSON.parse(localStorage.getItem('chapterNotes')) || {}; 
        let favorites = JSON.parse(localStorage.getItem('favorites')) || []; 
        let actionPlan = JSON.parse(localStorage.getItem('actionPlan')) || [];
        let dailyGoalMinutes = parseInt(localStorage.getItem('dailyGoalMinutes')) || 30;
        let activeNoteId = null;
        let pomoInterval = null, pomoTime = 1500, pomoActive = false;
        let countdownInterval = null;

        function safeSet(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }

        function switchView(viewName) {
            ['library', 'notes', 'stats'].forEach(v => {
                const el = document.getElementById(`view-${v}`);
                const tab = document.getElementById(`tab-${v}`);
                if(el) el.classList.add('hidden');
                if(tab) tab.classList.remove('active');
            });
            const vEl = document.getElementById(`view-${viewName}`);
            const tEl = document.getElementById(`tab-${viewName}`);
            if(vEl) vEl.classList.remove('hidden');
            if(tEl) tEl.classList.add('active');
            if(viewName === 'stats') { renderStats(); renderHeatmap(); }
            if(viewName === 'notes') renderAllNotes();
            if(viewName === 'library') { renderLibraryList(); renderActionPlan(); }
        }

        function switchBook(bookId) {
            if (!library[bookId]) bookId = 'habitosAtomicos';
            currentBookId = bookId; localStorage.setItem('activeBookId', bookId);
            document.querySelectorAll('.book-select-btn').forEach(btn => {
                btn.classList.remove('bg-amber-500', 'text-white');
                btn.classList.add('bg-white', 'dark:bg-slate-900', 'text-slate-600', 'dark:text-slate-400', 'border', 'dark:border-slate-700');
            });
            const activeBtn = document.getElementById(`book-btn-${bookId}`);
            if(activeBtn) { activeBtn.classList.remove('bg-white', 'dark:bg-slate-900'); activeBtn.classList.add('bg-amber-500', 'text-white'); }
            safeSet('book-title-display', library[bookId].title);
            safeSet('book-author-display', library[bookId].author);
            loadRandomQuote(); renderLibraryList();
        }

        function toggleComplete(id, title, start, end, e) {
            if(e) e.stopPropagation();
            const dur = parseTimeStr(end) - parseTimeStr(start);
            const idx = listeningHistory.findIndex(l => l.sectionId === id && l.bookId === currentBookId);
            if (idx > -1) listeningHistory.splice(idx, 1);
            else { listeningHistory.push({ timestamp: Date.now(), duration: dur, bookId: currentBookId, sectionId: id, title: title }); triggerConfetti(); }
            localStorage.setItem('listeningHistory', JSON.stringify(listeningHistory));
            renderLibraryList(); updateGlobalProgress();
        }

        function toggleFavorite(id, e) {
            if(e) e.stopPropagation();
            const key = `${currentBookId}_${id}`;
            const idx = favorites.indexOf(key);
            if(idx > -1) favorites.splice(idx, 1); else favorites.push(key);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            renderLibraryList();
        }

        function renderLibraryList() {
            const container = document.getElementById('app-container'), book = library[currentBookId], search = (document.getElementById('chapter-search')?.value || "").toLowerCase();
            if(!container) return; container.innerHTML = ''; let firstUnc = false, bookComp = 0, bookTotal = 0;
            const completedIds = listeningHistory.filter(l => l.bookId === currentBookId).map(l => l.sectionId);

            book.sections.forEach(sec => {
                const filtered = sec.items.filter(i => i.title.toLowerCase().includes(search));
                if(filtered.length === 0 && search) return;
                const secEl = document.createElement('div');
                secEl.innerHTML = `<h3 class="text-xs font-bold text-slate-400 uppercase mb-2 ml-1">${sec.title}</h3><div class="bg-white dark:bg-slate-900 rounded-xl border dark:border-slate-800 overflow-hidden shadow-sm"></div>`;
                const list = secEl.querySelector('div');
                sec.items.forEach(item => {
                    if(search && !item.title.toLowerCase().includes(search)) return;
                    const done = completedIds.includes(item.id), dur = parseTimeStr(item.end) - parseTimeStr(item.start);
                    bookTotal += dur; if(done) bookComp += dur;
                    const next = !done && !firstUnc; if(next) firstUnc = true;
                    const isFav = favorites.includes(`${currentBookId}_${item.id}`);
                    const itemEl = document.createElement('div');
                    itemEl.className = `item-row group flex items-center justify-between p-3 border-b dark:border-slate-800 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-800/50 ${done ? 'bg-slate-50/50 dark:bg-slate-950/50' : ''} ${next ? 'next-up' : ''}`;
                    itemEl.innerHTML = `<div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="toggleComplete(${item.id}, '${item.title}', '${item.start}', '${item.end}', event)">
                        <button class="check-btn ${done ? 'completed' : ''}"><i data-lucide="circle" class="w-5 h-5 icon-circle"></i><i data-lucide="check-circle" class="w-5 h-5 icon-check"></i></button>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-0.5"><span class="next-badge text-[9px] font-bold text-amber-600 bg-amber-100 px-1 rounded uppercase">Siguiente</span><p class="text-sm font-medium ${done ? 'line-through text-slate-400 decoration-slate-300 font-normal' : 'font-bold'} leading-tight">${item.title}</p></div>
                            <div class="text-[10px] text-slate-400 font-mono flex gap-2"><i data-lucide="clock" class="w-3 h-3"></i> ${formatDuration(dur)} ${chapterNotes[`${currentBookId}_${item.id}`] ? '• Nota' : ''}</div>
                        </div></div>
                        <div class="flex items-center gap-1">
                            <button onclick="toggleFavorite(${item.id}, event)" class="p-2 ${isFav ? 'text-amber-500' : 'text-slate-300'}"><i data-lucide="star" class="w-4 h-4 ${isFav ? 'fill-current' : ''}"></i></button>
                            <button onclick="openNotes(${item.id}, '${item.title}')" class="p-2 text-slate-300 hover:text-amber-500"><i data-lucide="pen-tool" class="w-4 h-4"></i></button>
                            <button onclick="openVideo('${item.start}', '${item.end}', '${item.videoId||''}')" class="p-2 bg-slate-100 dark:bg-slate-800 text-slate-500 rounded-full hover:bg-amber-500 hover:text-white transition-all"><i data-lucide="play" class="w-3 h-3 fill-current ml-0.5"></i></button>
                        </div>`;
                    list.appendChild(itemEl);
                });
                if(list.children.length > 0) container.appendChild(secEl);
            });
            safeSet('book-progress-text', `${bookTotal > 0 ? Math.round((bookComp / bookTotal) * 100) : 0}%`);
            safeSet('book-time-text', `${formatDuration(bookComp)} / ${formatDuration(bookTotal)}`);
            updateGlobalProgress(); lucide.createIcons();
        }

        function renderStats() {
            const todayStart = new Date().setHours(0,0,0,0);
            let todaySec = 0, totalSec = 0; const actMap = {}, bMap = {};
            listeningHistory.forEach(l => {
                totalSec += l.duration || 0; if(!bMap[l.bookId]) bMap[l.bookId] = 0; bMap[l.bookId] += l.duration;
                const dK = new Date(l.timestamp).toISOString().split('T')[0]; actMap[dK] = (actMap[dK] || 0) + l.duration;
                if(l.timestamp >= todayStart) todaySec += l.duration;
            });
            safeSet('stat-today', todaySec < 60 ? todaySec + 's' : formatDuration(todaySec));
            safeSet('stat-chapters', listeningHistory.length);
            safeSet('stat-total-time', formatDuration(totalSec));
            safeSet('stat-level', totalSec > 36000 ? "Sabio" : totalSec > 18000 ? "Erudito" : "Novato");
            
            let streak = 0; let check = new Date();
            while(actMap[check.toISOString().split('T')[0]]) { streak++; check.setDate(check.getDate() - 1); }
            safeSet('stat-streak', streak + " d");

            const ring = document.getElementById('daily-progress-ring'), pct = Math.min(100, Math.round((todaySec / (dailyGoalMinutes * 60)) * 100));
            if(ring) ring.style.strokeDashoffset = 351.86 - (351.86 * pct / 100);
            safeSet('daily-progress-val', pct + '%');

            const chart = document.getElementById('weekly-chart'); if(chart) {
                chart.innerHTML = '';
                for(let i=6; i>=0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i); const k = d.toISOString().split('T')[0], v = actMap[k] || 0;
                    chart.innerHTML += `<div class="flex-1 flex flex-col justify-end items-center gap-1 h-full"><div class="w-full max-w-[20px] bg-amber-400 rounded-t" style="height:${Math.min(100, (v/3600)*100)}%"></div><span class="text-[8px] uppercase text-slate-400">${d.toLocaleDateString('es',{weekday:'short'}).slice(0,2)}</span></div>`;
                }
            }
            if(totalSec > 0) {
                let currentDeg = 0, gradStr = ""; const legend = document.getElementById('distribution-legend');
                if(legend) {
                    legend.innerHTML = '';
                    Object.keys(bMap).forEach((bId) => {
                        if (!library[bId]) return;
                        const pctB = (bMap[bId] / totalSec) * 100; const deg = (pctB / 100) * 360; const color = library[bId].color;
                        gradStr += `${color} ${currentDeg}deg ${currentDeg + deg}deg, `;
                        currentDeg += deg;
                        legend.innerHTML += `<div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full" style="background-color: ${color}"></span><span class="dark:text-slate-300 truncate w-32 font-medium">${library[bId].title} (${Math.round(pctB)}%)</span></div>`;
                    });
                    const pie = document.getElementById('distribution-pie'); if(pie) pie.style.background = `conic-gradient(${gradStr.slice(0, -2) || '#e2e8f0 0% 100%'})`;
                }
            }
            lucide.createIcons();
        }

        function renderHeatmap() {
            const container = document.getElementById('streak-heatmap'); if(!container) return; container.innerHTML = '';
            const actMap = {}; listeningHistory.forEach(l => { const k = new Date(l.timestamp).toISOString().split('T')[0]; actMap[k] = (actMap[k] || 0) + l.duration; });
            for(let i=89; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i); const k = d.toISOString().split('T')[0], v = actMap[k] || 0;
                const cell = document.createElement('div'); cell.className = `heatmap-cell level-${v === 0 ? 0 : v < 900 ? 1 : v < 1800 ? 2 : v < 3600 ? 3 : 4}`;
                cell.title = `${d.toLocaleDateString('es')}: ${Math.round(v/60)} min`;
                container.appendChild(cell);
            }
        }

        function togglePomodoro() {
            pomoActive = !pomoActive; const btn = document.getElementById('pomo-btn');
            if(pomoActive) {
                btn.innerHTML = '<i data-lucide="square" class="w-4 h-4"></i>';
                pomoInterval = setInterval(() => {
                    pomoTime--;
                    if(pomoTime <= 0) { clearInterval(pomoInterval); alert("Sesión terminada"); pomoActive = false; pomoTime = 1500; }
                    const m = Math.floor(pomoTime/60), s = pomoTime%60;
                    safeSet('pomo-timer', `${m}:${s < 10 ? '0' : ''}${s}`);
                }, 1000);
            } else { btn.innerHTML = '<i data-lucide="play" class="w-4 h-4"></i>'; clearInterval(pomoInterval); }
            lucide.createIcons();
        }

        function renderAllNotes(onlyFavs = false) {
            const container = document.getElementById('all-notes-container'); if(!container) return; container.innerHTML = '';
            const grouped = {};
            Object.keys(chapterNotes).forEach(k => { 
                const [b, s] = k.split('_'); if(onlyFavs && !favorites.includes(k)) return;
                if(!grouped[b]) grouped[b] = []; grouped[b].push({s, t: chapterNotes[k], isFav: favorites.includes(k)}); 
            });
            if(Object.keys(grouped).length === 0) { container.innerHTML = '<p class="text-slate-400 italic text-center py-10">Sin notas aún.</p>'; return; }
            Object.keys(grouped).forEach(b => {
                if(!library[b]) return;
                const el = document.createElement('div'); el.className = 'bg-white dark:bg-slate-900 p-5 rounded-xl border dark:border-slate-800 mb-4 shadow-sm';
                let html = `<h3 class="font-bold border-b pb-2 mb-3 flex items-center gap-2 dark:text-white"><span class="w-3 h-3 rounded-full" style="background-color:${library[b].color}"></span>${library[b].title}</h3>`;
                grouped[b].forEach(n => {
                    let cT = "Capítulo"; Object.values(library[b].sections).forEach(s => { const i = s.items.find(x => x.id == n.s); if(i) cT = i.title; });
                    html += `<div class="mb-4 last:mb-0"><div class="flex items-center gap-2 mb-1"><h4 class="text-[10px] font-bold text-amber-600 uppercase">${cT}</h4>${n.isFav ? '<i data-lucide="star" class="w-3 h-3 text-amber-500 fill-current"></i>' : ''}</div><p class="text-sm text-slate-600 dark:text-slate-400 italic whitespace-pre-wrap bg-slate-50 dark:bg-slate-950 p-3 rounded-lg border-l-2 border-slate-200 dark:border-slate-800">"${n.t}"</p></div>`;
                });
                el.innerHTML = html; container.appendChild(el);
            });
            lucide.createIcons();
        }

        function renderActionPlan() {
            const list = document.getElementById('action-plan-list'); if(!list) return; list.innerHTML = actionPlan.length ? '' : '<p class="text-xs text-slate-400 italic font-medium">No hay pasos atómicos definidos.</p>';
            actionPlan.forEach((it, i) => {
                const el = document.createElement('div'); el.className = 'flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-950 rounded-lg border dark:border-slate-800 shadow-sm';
                el.innerHTML = `<div class="flex gap-3 items-center"><input type="checkbox" ${it.done?'checked':''} onchange="toggleAction(${i})" class="accent-amber-500 w-4 h-4 rounded"><span class="text-sm ${it.done?'line-through opacity-50 dark:text-slate-500 text-slate-400 font-normal':'text-slate-700 dark:text-slate-300 font-bold'}">${it.text}</span></div><button onclick="removeAction(${i})" class="text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                list.appendChild(el);
            });
            lucide.createIcons();
        }

        function addActionItem() { const input = document.getElementById('new-action-input'); if(!input.value.trim()) return; actionPlan.push({text: input.value, done: false}); localStorage.setItem('actionPlan', JSON.stringify(actionPlan)); input.value = ''; renderActionPlan(); }
        function toggleAction(i) { actionPlan[i].done = !actionPlan[i].done; localStorage.setItem('actionPlan', JSON.stringify(actionPlan)); renderActionPlan(); if(actionPlan[i].done) triggerConfetti(); }
        function removeAction(i) { actionPlan.splice(i, 1); localStorage.setItem('actionPlan', JSON.stringify(actionPlan)); renderActionPlan(); }
        
        function resetCurrentBook() { 
            if(confirm("¿Borrar todo el progreso de este audiolibro? Todos los marcadores visuales serán eliminados.")) {
                listeningHistory = listeningHistory.filter(l => l.bookId !== currentBookId);
                localStorage.setItem('listeningHistory', JSON.stringify(listeningHistory));
                renderLibraryList();
                updateGlobalProgress();
                alert("Progreso del libro seleccionado reiniciado.");
            }
        }

        function parseTimeStr(t) { const p = t.split(':').map(Number); return p.length === 3 ? p[0]*3600 + p[1]*60 + p[2] : p[0]*60 + p[1]; }
        function formatDuration(s) { const h = Math.floor(s/3600), m = Math.floor((s%3600)/60); return h > 0 ? `${h}h ${m}m` : `${m} min`; }
        function loadRandomQuote() { const q = library[currentBookId].quotes; safeSet('quote-text', `"${q[Math.floor(Math.random()*q.length)]}"`); safeSet('quote-author', `— ${library[currentBookId].author}`); }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); }
        function triggerConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
        
        function openVideo(s, e, v) { 
            const start = parseTimeStr(s), end = parseTimeStr(e), id = v || library[currentBookId].videoId; 
            document.getElementById('youtube-iframe').src = `https://www.youtube.com/embed/${id}?start=${start}&end=${end}&autoplay=1&rel=0`; 
            document.getElementById('video-modal').classList.remove('hidden'); 
            startCountdown(end - start);
        }

        function startCountdown(seconds) {
            if(countdownInterval) clearInterval(countdownInterval);
            let rem = seconds; updateCountdownUI(rem);
            countdownInterval = setInterval(() => { rem--; if(rem <= 0) { clearInterval(countdownInterval); closeVideo(); } updateCountdownUI(rem); }, 1000);
        }

        function updateCountdownUI(sec) {
            const m = Math.floor(sec/60), s = sec%60;
            const text = `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
            const el = document.getElementById('playback-countdown'); if(el) el.innerText = text;
        }

        function closeVideo() { document.getElementById('youtube-iframe').src = ""; document.getElementById('video-modal').classList.add('hidden'); if(countdownInterval) clearInterval(countdownInterval); }
        function openNotes(id, title) { activeNoteId = `${currentBookId}_${id}`; safeSet('note-chapter-title', title); document.getElementById('note-textarea').value = chapterNotes[activeNoteId] || ""; document.getElementById('notes-modal').classList.remove('hidden'); }
        function saveNote() { const v = document.getElementById('note-textarea').value; if(v.trim()) chapterNotes[activeNoteId] = v; else delete chapterNotes[activeNoteId]; localStorage.setItem('chapterNotes', JSON.stringify(chapterNotes)); closeNotes(); renderLibraryList(); }
        function closeNotes() { document.getElementById('notes-modal').classList.add('hidden'); activeNoteId = null; }
        function showStats() { switchView('stats'); }
        function adjustDailyGoal(a) { dailyGoalMinutes = Math.max(5, dailyGoalMinutes + a); localStorage.setItem('dailyGoalMinutes', dailyGoalMinutes); renderStats(); }
        
        function updateGlobalProgress() { 
            let total = 0; Object.values(library).forEach(b => b.sections.forEach(s => total += s.items.length));
            const bar = document.getElementById('global-progress-bar'); if(bar) bar.style.width = (Math.round((listeningHistory.length / total) * 100) || 0) + '%';
        }

        function exportData() { const d = {history: listeningHistory, notes: chapterNotes, plan: actionPlan, favs: favorites, goal: dailyGoalMinutes}; const blob = new Blob([JSON.stringify(d)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'audiolibro_progreso.json'; a.click(); }
        function triggerImport() { document.getElementById('import-file').click(); }
        function handleFileImport(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader(); reader.onload = (ev) => {
                try {
                    const imp = JSON.parse(ev.target.result);
                    if(imp.history) listeningHistory = [...new Map([...listeningHistory, ...imp.history].map(i => [i.bookId+i.sectionId, i])).values()];
                    if(imp.notes) Object.assign(chapterNotes, imp.notes);
                    if(imp.plan) actionPlan = imp.plan;
                    if(imp.favs) favorites = imp.favs;
                    localStorage.setItem('listeningHistory', JSON.stringify(listeningHistory)); localStorage.setItem('chapterNotes', JSON.stringify(chapterNotes)); localStorage.setItem('actionPlan', JSON.stringify(actionPlan)); localStorage.setItem('favorites', JSON.stringify(favorites));
                    switchBook(currentBookId); alert("Importación exitosa."); triggerConfetti();
                } catch(err) { alert("Archivo inválido."); }
            }; reader.readAsText(file);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            const stored = localStorage.getItem('activeBookId'); if(stored && library[stored]) currentBookId = stored;
            switchBook(currentBookId);
        });
    </script>
</body>
</html>
