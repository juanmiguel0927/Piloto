<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audiolibro - Seguimiento y Acción</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' },
                        amber: { 450: '#f59e0b' }
                    }
                }
            }
        }
    </script>
    
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        .transition-width { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .check-btn:hover .icon-circle { opacity: 0; }
        .check-btn:hover .icon-check { opacity: 0.5; }
        .check-btn.completed .icon-circle { display: none; }
        .check-btn.completed .icon-check { display: block; opacity: 1; color: #22c55e; transform: scale(1.1); }
        .check-btn:not(.completed) .icon-check { display: none; }

        .next-up { border-left: 4px solid #f59e0b; background-color: #fffbeb; }
        .dark .next-up { background-color: #451a03; border-left-color: #d97706; }
        .next-up .next-badge { display: inline-flex; }
        .item-row:not(.next-up) .next-badge { display: none; }

        .modal-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-overlay.hidden { display: none; opacity: 0; pointer-events: none; }
        .modal-overlay:not(.hidden) { display: flex; opacity: 1; pointer-events: auto; }

        .tab-btn { position: relative; }
        .tab-btn.active { color: #f59e0b; font-weight: 600; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background-color: #f59e0b; }
        .tab-btn:not(.active) { color: #64748b; }
        .dark .tab-btn:not(.active) { color: #94a3b8; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Estilos para el nuevo Heatmap de Calendario */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { width: 100%; aspect-ratio: 1; border-radius: 2px; }
        
        /* Estilos para el gráfico de barras simple */
        .bar-container { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; gap: 4px; height: 100%; }
        .bar-fill { width: 100%; max-width: 24px; border-radius: 4px 4px 0 0; transition: height 0.5s ease; min-height: 4px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans pb-12 transition-colors duration-300 dark:bg-slate-950 dark:text-slate-200">

    <!-- Header Fijo -->
    <div class="sticky top-0 z-20 bg-white shadow-sm border-b border-slate-200 dark:bg-slate-900 dark:border-slate-800 transition-colors duration-300">
        <div class="max-w-4xl mx-auto px-4 pt-4 pb-0">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 gap-3">
                <div class="flex items-center gap-3">
                    <h1 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2 uppercase tracking-tighter">
                        <i data-lucide="book-open" class="w-6 h-6 text-amber-500"></i>
                        Audiolibro
                    </h1>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 transition-colors">
                        <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                        <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                    </button>
                </div>

                <!-- Widget de Frases Aleatorias con Autor -->
                <div class="flex-1 hidden md:flex justify-end max-w-lg">
                    <div id="quote-widget" class="flex items-center gap-3 bg-slate-50 dark:bg-slate-800/50 px-4 py-2 rounded-lg border border-slate-100 dark:border-slate-800 shadow-sm min-h-[42px]">
                        <i data-lucide="quote" class="w-4 h-4 text-amber-500 shrink-0"></i>
                        <p id="header-quote-text" class="text-xs font-medium italic text-slate-600 dark:text-slate-400 transition-opacity duration-300"></p>
                    </div>
                </div>
            </div>
            
            <div class="w-full bg-slate-200 dark:bg-slate-800 rounded-full h-1.5 overflow-hidden mb-4">
                <div id="global-progress-bar" class="bg-amber-500 h-1.5 rounded-full transition-width" style="width: 0%"></div>
            </div>

            <div class="flex space-x-6 overflow-x-auto scrollbar-hide">
                <button onclick="switchView('library')" id="tab-library" class="tab-btn pb-3 px-1 text-sm whitespace-nowrap transition-colors active">Biblioteca</button>
                <button onclick="switchView('notes')" id="tab-notes" class="tab-btn pb-3 px-1 text-sm whitespace-nowrap transition-colors">Notas y Favoritos</button>
                <button onclick="switchView('stats')" id="tab-stats" class="tab-btn pb-3 px-1 text-sm whitespace-nowrap transition-colors">Balance & Constancia</button>
            </div>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="max-w-4xl mx-auto px-4 mt-6">

        <!-- VISTA: BIBLIOTECA -->
        <div id="view-library" class="fade-in">
            <!-- Pestañas de Libros (Nombres Completos) -->
            <div class="flex space-x-2 overflow-x-auto scrollbar-hide mb-6 pb-2">
                <button onclick="switchBook('habitosAtomicos')" id="book-btn-habitosAtomicos" class="book-select-btn px-4 py-2 rounded-full text-xs font-bold transition-all border dark:border-slate-700 whitespace-nowrap shadow-sm">Hábitos Atómicos</button>
                <button onclick="switchBook('cosasBuenas')" id="book-btn-cosasBuenas" class="book-select-btn px-4 py-2 rounded-full text-xs font-bold transition-all border dark:border-slate-700 whitespace-nowrap shadow-sm">Cómo hacer que te pasen cosas buenas</button>
                <button onclick="switchBook('sieteHabitos')" id="book-btn-sieteHabitos" class="book-select-btn px-4 py-2 rounded-full text-xs font-bold transition-all border dark:border-slate-700 whitespace-nowrap shadow-sm">Los 7 Hábitos</button>
                <button onclick="switchBook('personaVitamina')" id="book-btn-personaVitamina" class="book-select-btn px-4 py-2 rounded-full text-xs font-bold transition-all border dark:border-slate-700 whitespace-nowrap shadow-sm">Persona Vitamina</button>
                <button onclick="switchBook('pensarDemasiado')" id="book-btn-pensarDemasiado" class="book-select-btn px-4 py-2 rounded-full text-xs font-bold transition-all border dark:border-slate-700 whitespace-nowrap shadow-sm">Cómo dejar de pensar demasiado</button>
            </div>

            <div class="relative mb-6">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                <input type="text" id="chapter-search" oninput="renderLibraryList()" placeholder="Buscar capítulo..." class="w-full pl-10 pr-4 py-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl text-sm outline-none shadow-sm transition-all focus:ring-2 focus:ring-amber-500/50">
            </div>

            <!-- Título Completo de la Obra Seleccionada -->
            <div class="mb-6 px-1">
                <h2 id="book-title-display" class="text-2xl font-black text-slate-900 dark:text-white leading-tight mb-1"></h2>
                <p id="book-author-display" class="text-sm font-bold text-amber-600 dark:text-amber-500 flex items-center gap-1">
                    <i data-lucide="user" class="w-3 h-3"></i> <span></span>
                </p>
            </div>

            <!-- Progreso del Libro -->
            <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 mb-6 shadow-sm flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Progreso Actual</p>
                    <div class="w-full bg-slate-100 dark:bg-slate-800 rounded-full h-2">
                        <div id="book-inner-progress" class="bg-amber-500 h-2 rounded-full transition-width" style="width: 0%"></div>
                    </div>
                </div>
                <div class="ml-6 text-right">
                    <span id="book-progress-text" class="text-2xl font-black text-slate-800 dark:text-slate-100">0%</span>
                    <p id="book-time-text" class="text-[10px] text-slate-400 font-mono">0h / 0h</p>
                </div>
            </div>

            <div id="app-container" class="space-y-6 pb-8"></div>
            
            <!-- PLAN DE ACCIÓN PERSONAL DETALLADO -->
            <div id="plan-accion-section" class="mt-8 p-6 bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800">
                <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2 mb-4 text-lg">
                    <i data-lucide="zap" class="w-5 h-5 text-amber-500"></i> Plan de Acción Personal
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-slate-600 dark:text-slate-400 text-xs leading-relaxed">
                    <div class="p-4 bg-blue-50/50 dark:bg-slate-850 rounded-lg border border-blue-100 dark:border-slate-800 shadow-inner">
                        <p class="font-black text-blue-700 dark:text-blue-400 uppercase mb-2">1. Definir la Intención</p>
                        <p>No anotes deseos. Anota compromisos: "Yo haré <strong>[Acción]</strong> a las <strong>[Hora]</strong> en <strong>[Lugar]</strong>".</p>
                    </div>
                    <div class="p-4 bg-green-50/50 dark:bg-slate-850 rounded-lg border border-green-100 dark:border-slate-800 shadow-inner">
                        <p class="font-black text-green-700 dark:text-green-400 uppercase mb-2">2. El Paso Atómico</p>
                        <p>Usa la <strong>Regla de los 2 Minutos</strong>. Si quieres meditar 30 min, anota: "Sentarme 2 min en silencio".</p>
                    </div>
                    <div class="p-4 bg-purple-50/50 dark:bg-slate-850 rounded-lg border border-purple-100 dark:border-slate-800 shadow-inner">
                        <p class="font-black text-purple-700 dark:text-purple-400 uppercase mb-2">3. Disparador Visual</p>
                        <p>Haz que el hábito sea <strong>obvio</strong>. Coloca una señal física en tu camino para que sea inevitable verlo.</p>
                    </div>
                </div>

                <div id="action-plan-list" class="space-y-3"></div>
                <div class="mt-6 flex gap-2">
                    <input type="text" id="new-action-input" class="flex-1 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-amber-500 shadow-inner" placeholder="Escribe tu próximo paso atómico...">
                    <button onclick="addActionItem()" class="bg-amber-500 hover:bg-amber-600 text-white px-6 py-3 rounded-lg text-sm font-bold transition-all shadow-md active:scale-95">Añadir</button>
                </div>
            </div>

             <div class="mt-12 mb-12 text-center border-t border-slate-200 dark:border-slate-800 pt-8">
                <button onclick="resetCurrentBook()" class="group text-xs text-slate-400 hover:text-red-500 transition-colors mb-4 flex items-center justify-center gap-2 mx-auto font-bold tracking-tighter uppercase">
                    <i data-lucide="rotate-ccw" class="w-3 h-3 group-hover:rotate-[-90deg] transition-transform duration-500"></i> Reiniciar progreso del libro actual
                </button>
            </div>
        </div>

        <!-- VISTA: CENTRO DE REFLEXIÓN -->
        <div id="view-notes" class="hidden fade-in space-y-6">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-xl font-bold text-slate-800 dark:text-white leading-tight">Notas y Favoritos</h2>
                <div class="flex gap-2">
                    <button onclick="renderAllNotes(true)" class="text-xs bg-white dark:bg-slate-800 border dark:border-slate-700 px-3 py-2 rounded-lg text-slate-600 dark:text-slate-300 font-bold">Solo Favoritos</button>
                    <button onclick="window.print()" class="text-xs bg-amber-500 text-white px-3 py-2 rounded-lg font-bold shadow-sm">Exportar PDF</button>
                </div>
            </div>
            <div id="all-notes-container" class="space-y-4 pb-8"></div>
        </div>

        <!-- VISTA: ESTADÍSTICAS MEJORADA -->
        <div id="view-stats" class="hidden fade-in space-y-8">
            <!-- Balance de Utilización (Gráfico Filtrable) -->
             <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300 flex items-center gap-2 uppercase tracking-widest">
                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-blue-500"></i> Balance de Utilización
                    </h3>
                    <div class="flex gap-1 bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                        <button onclick="updateChartFilter('week')" id="filter-week" class="filter-btn text-[10px] font-bold px-3 py-1.5 rounded-md transition-all">7 Días</button>
                        <button onclick="updateChartFilter('month')" id="filter-month" class="filter-btn text-[10px] font-bold px-3 py-1.5 rounded-md transition-all">Mes</button>
                        <button onclick="updateChartFilter('year')" id="filter-year" class="filter-btn text-[10px] font-bold px-3 py-1.5 rounded-md transition-all">Año</button>
                    </div>
                </div>
                <!-- Gráfico CSS Simple -->
                <div id="stats-chart-container" class="h-40 w-full flex items-end justify-between gap-2 px-2 pb-4">
                    <!-- Las barras se inyectan aquí -->
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800 shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Escucha Hoy</p>
                    <p id="stat-today" class="text-2xl font-black text-blue-500">0m</p>
                </div>
                <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800 shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Racha</p>
                    <p id="stat-streak" class="text-2xl font-black text-orange-500">0 d</p>
                </div>
                <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800 shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Tiempo Total</p>
                    <p id="stat-total-time" class="text-2xl font-black dark:text-white">0h</p>
                </div>
                <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800 shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Nivel</p>
                    <p id="stat-level" class="text-lg font-black text-amber-500">Novato</p>
                </div>
            </div>

            <!-- Heatmap Atractivo (Calendario) -->
            <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm text-center">
                <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-6 flex items-center gap-2 justify-center uppercase tracking-widest">
                    <i data-lucide="calendar-check" class="w-4 h-4 text-green-500"></i> Mapa de Constancia
                </h3>
                <div id="streak-heatmap" class="flex flex-wrap gap-6 justify-center"></div>
            </div>

            <!-- Historial Detallado por Mes -->
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                <div class="p-4 bg-slate-50 dark:bg-slate-850 border-b border-slate-100 dark:border-slate-800">
                     <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300 flex items-center gap-2 uppercase tracking-widest">
                        <i data-lucide="history" class="w-4 h-4 text-slate-400"></i> Historial de Actividad
                    </h3>
                </div>
                <div id="detailed-history-list" class="divide-y divide-slate-100 dark:divide-slate-800 max-h-96 overflow-y-auto">
                    <!-- Items del historial -->
                </div>
            </div>
            
            <div class="text-center pb-8 flex flex-col items-center gap-3">
                <div class="flex gap-4">
                    <button onclick="exportData()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-lg text-xs font-bold shadow-sm transition-all hover:bg-slate-200"><i data-lucide="download" class="w-4 h-4"></i> Exportar Datos</button>
                    <button onclick="triggerImport()" class="flex items-center gap-2 px-4 py-2 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded-lg text-xs font-bold shadow-sm transition-all hover:bg-amber-200"><i data-lucide="upload" class="w-4 h-4"></i> Importar Datos</button>
                </div>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="handleFileImport(event)">
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div id="video-modal" class="modal-overlay hidden fixed inset-0 z-50 items-center justify-center bg-black/90 p-4 backdrop-blur-sm">
        <div class="bg-black w-full max-w-4xl rounded-xl overflow-hidden shadow-2xl relative flex flex-col border border-slate-800">
            <div class="flex items-center justify-between p-3 bg-slate-900 text-white border-b border-slate-800">
                <div class="flex items-center gap-4">
                    <span class="text-sm font-black flex items-center gap-2 text-amber-500 uppercase tracking-tighter"><i data-lucide="play" class="w-4 h-4 fill-current"></i> Reproduciendo</span>
                    <div class="px-3 py-1 bg-slate-800 border border-slate-700 rounded-lg text-[11px] font-black flex items-center gap-2 shadow-sm">
                        <i data-lucide="clock" class="w-3 h-3 text-amber-500"></i> Resta: <span id="playback-countdown" class="font-mono text-white">00:00</span>
                    </div>
                </div>
                <button onclick="closeVideo()" class="text-slate-400 hover:text-white p-2 hover:bg-slate-800 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="relative w-full aspect-video"><iframe id="youtube-iframe" class="absolute inset-0 w-full h-full" src="" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
        </div>
    </div>

    <div id="notes-modal" class="modal-overlay hidden fixed inset-0 z-50 items-center justify-center bg-black/50 p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-xl shadow-2xl flex flex-col border dark:border-slate-800 overflow-hidden">
            <div class="p-4 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-850"><h3 class="font-bold dark:text-white flex items-center gap-2 text-sm"><i data-lucide="pen-tool" class="w-4 h-4 text-amber-500"></i> Cuaderno de Reflexiones</h3><button onclick="closeNotes()"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="p-5"><p id="note-chapter-title" class="text-[10px] text-amber-600 mb-3 font-black uppercase tracking-widest leading-tight"></p><textarea id="note-textarea" class="w-full h-48 p-4 rounded-xl bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 text-sm outline-none focus:ring-2 focus:ring-amber-500 resize-none shadow-inner" placeholder="Escribe tus aprendizajes aquí..."></textarea></div>
            <div class="p-4 border-t dark:border-slate-800 flex justify-end bg-slate-50 dark:bg-slate-850"><button onclick="saveNote()" class="px-6 py-2.5 bg-amber-500 text-white rounded-lg text-sm font-black shadow-md hover:bg-amber-600 transition-all">Guardar Nota</button></div>
        </div>
    </div>

    <script>
        const library = {
            habitosAtomicos: { 
                title: "Hábitos Atómicos", 
                author: "James Clear", 
                color: "#ef4444", 
                videoId: "CgGiyfv7Xpc", 
                quotes: ["No te elevas al nivel de tus metas. Caes al nivel de tus sistemas.", "Los hábitos son el interés compuesto de la superación personal.", "Cada acción que realizas es un voto por el tipo de persona en la que deseas convertirte.", "Si quieres mejores resultados, olvida las metas. Concéntrate en tu sistema."], 
                sections: [
                    { title: "Introducción y Fundamentos", items: [
                        { id: 0, title: "Introducción: Mi historia", start: "00:00:00", end: "00:26:50" },
                        { id: 1, title: "Capítulo 1: El sorprendente poder de los hábitos atómicos", start: "00:27:05", end: "00:46:00" },
                        { id: 2, title: "Capítulo 2: La manera en que tus hábitos moldean tu identidad", start: "01:05:30", end: "01:21:00" },
                        { id: 3, title: "Capítulo 3: Cómo construir mejores hábitos en 4 pasos", start: "01:36:11", end: "02:07:09" }
                    ]},
                    { title: "1ª Ley: Hacerlo Obvio", items: [
                        { id: 4, title: "Capítulo 4: El hombre que no se veía bien", start: "02:07:09", end: "02:26:54" },
                        { id: 5, title: "Capítulo 5: La mejor manera de comenzar un nuevo hábito", start: "02:26:54", end: "02:50:02" },
                        { id: 6, title: "Capítulo 6: La motivación está sobrevalorada; el entorno importa más", start: "02:50:02", end: "03:12:44" },
                        { id: 7, title: "Capítulo 7: El secreto del autocontrol", start: "03:12:44", end: "03:23:53" }
                    ]},
                    { title: "2ª Ley: Hacerlo Atractivo", items: [
                        { id: 8, title: "Capítulo 8: Cómo lograr que un hábito sea irresistible", start: "03:24:07", end: "03:49:54" },
                        { id: 9, title: "Capítulo 9: El papel de la familia y los amigos", start: "03:49:54", end: "04:14:32" },
                        { id: 10, title: "Capítulo 10: Cómo localizar y arreglar las causas de tus malos hábitos", start: "04:14:32", end: "04:36:52" }
                    ]},
                    { title: "3ª Ley: Hacerlo Sencillo", items: [
                        { id: 11, title: "Capítulo 11: Avanza despacio, pero no des marcha atrás", start: "04:37:06", end: "04:49:33" },
                        { id: 12, title: "Capítulo 12: La ley del menor esfuerzo", start: "04:49:33", end: "05:13:20" },
                        { id: 13, title: "Capítulo 13: Cómo dejar de postergar usando la Regla de los 2 Minutos", start: "05:13:20", end: "05:30:02" },
                        { id: 14, title: "Capítulo 14: Cómo hacer inevitables los buenos hábitos", start: "05:30:02", end: "05:47:05" }
                    ]},
                    { title: "4ª Ley: Hacerlo Satisfactorio", items: [
                        { id: 15, title: "Capítulo 15: La regla cardinal del cambio de conducta", start: "05:47:18", end: "06:14:37" },
                        { id: 16, title: "Capítulo 16: Cómo mantener los buenos hábitos todos los días", start: "06:14:37", end: "06:39:28" },
                        { id: 17, title: "Capítulo 17: Cómo un socio corresponsable cambia todo", start: "06:39:28", end: "06:54:29" }
                    ]},
                    { title: "Tácticas Avanzadas", items: [
                        { id: 18, title: "Capítulo 18: La verdad acerca del talento", start: "06:54:43", end: "07:23:04" },
                        { id: 19, title: "Capítulo 19: La regla de Ricitos de Oro", start: "07:23:04", end: "07:41:26" },
                        { id: 20, title: "Capítulo 20: El inconveniente de crear buenos hábitos", start: "07:41:26", end: "08:06:22" },
                        { id: 21, title: "Conclusión final", start: "08:06:22", end: "08:11:42" }
                    ]}
                ]
            },
            cosasBuenas: { 
                title: "Cómo hacer que te pasen cosas buenas", 
                author: "Marian Rojas Estapé", 
                color: "#3b82f6", 
                videoId: "UiedpTbutXg", 
                quotes: ["La felicidad no se define, se experimenta.", "Comprender es aliviar.", "Tu mente no distingue lo real de lo imaginario.", "El sufrimiento es la distancia entre lo que aceptamos y lo que deseamos."], 
                sections: [
                    { title: "Mente y Cuerpo", items: [
                        { id: 100, title: "Introducción", start: "00:00:00", end: "00:11:59" },
                        { id: 101, title: "Capítulo 1: El cerebro humano y sistemas operativos", start: "00:11:59", end: "00:50:19" },
                        { id: 102, title: "Capítulo 2: El antídoto al sufrimiento: el amor", start: "00:50:19", end: "01:44:16" },
                        { id: 103, title: "Capítulo 3: El cortisol: Tu aliado y tu enemigo", start: "01:44:16", end: "02:24:57" },
                        { id: 104, title: "Capítulo 4: Ni lo que pasó ni lo que vendrá", start: "02:24:57", end: "03:35:49" },
                        { id: 105, title: "Capítulo 5: Vivir el momento presente", start: "03:35:49", end: "04:40:38" },
                        { id: 106, title: "Capítulo 6: Las emociones y su repercusión en la salud", start: "04:40:38", end: "05:37:21" },
                        { id: 107, title: "Capítulo 7: ¿Qué cosas o actitudes elevan el cortisol?", start: "05:37:21", end: "06:36:28" },
                        { id: 108, title: "Capítulo 8: ¿Cómo bajar el cortisol?", start: "06:36:28", end: "07:11:47" },
                        { id: 109, title: "Capítulo 9: Tu mejor versión", start: "07:11:47", end: "07:34:53" }
                    ]}
                ]
            },
            sieteHabitos: { 
                title: "Los 7 Hábitos de la Gente Altamente Efectiva", 
                author: "Stephen Covey", 
                color: "#10b981", 
                videoId: "SXaY1Bz8Ndk", 
                quotes: ["La victoria privada precede a la victoria pública.", "Busca primero entender.", "Para cambiar la situación, debemos cambiarnos a nosotros mismos.", "La proactividad no significa solo tomar la iniciativa, sino asumir la responsabilidad de hacer que las cosas sucedan."], 
                sections: [
                    { title: "Parte 1: Victoria Privada", items: [
                        { id: 200, title: "Introducción: Paradigmas y Principios", start: "00:00:22", end: "00:23:24" },
                        { id: 201, title: "Panorama General de los 7 Hábitos", start: "00:23:24", end: "00:36:25" },
                        { id: 202, title: "Principios de Efectividad", start: "00:36:25", end: "01:14:16" },
                        { id: 203, title: "Efectividad y Balance P/CP", start: "01:14:16", end: "01:26:57" },
                        { id: 204, title: "La Cuenta Bancaria Emocional", start: "01:26:57", end: "01:42:48" },
                        { id: 205, title: "Hábito 1: Ser Proactivo", start: "01:42:48", end: "02:10:10" },
                        { id: 206, title: "Círculo de Influencia vs Preocupación", start: "02:10:10", end: "02:38:33" },
                        { id: 207, title: "Hábito 2: Comenzar con un Fin en Mente", start: "02:38:33", end: "03:22:04" },
                        { id: 208, title: "Hábito 3: Poner Primero lo Primero", start: "03:22:04", end: "04:01:39" }
                    ]},
                    { title: "Parte 2: Victoria Pública", items: [
                        { id: 209, title: "Hábito 4: Pensar Ganar-Ganar", start: "00:00:24", end: "00:51:31", videoId: "-ucQ4gG25GY" },
                        { id: 210, title: "Hábito 5: Buscar primero entender, luego ser entendido", start: "00:51:31", end: "01:35:55", videoId: "-ucQ4gG25GY" },
                        { id: 211, title: "Hábito 6: Sinergizar", start: "01:35:55", end: "02:24:05", videoId: "-ucQ4gG25GY" },
                        { id: 212, title: "Hábito 7: Afilar la Sierra", start: "02:24:05", end: "02:48:07", videoId: "-ucQ4gG25GY" },
                        { id: 213, title: "Conclusión final", start: "02:48:07", end: "03:01:50", videoId: "-ucQ4gG25GY" }
                    ]}
                ]
            },
            personaVitamina: { 
                title: "Encuentra tu persona vitamina", 
                author: "Marian Rojas Estapé", 
                color: "#ec4899", 
                videoId: "26Atrg0YyVE", 
                quotes: ["Tus relaciones determinan tu salud.", "Abrazar libera oxitocina.", "Somos lo que protegemos.", "La oxitocina es el pegamento de la vida."], 
                sections: [
                    { title: "Oxitocina y Vínculos", items: [
                        { id: 300, title: "Introducción", start: "00:00:00", end: "00:07:34" },
                        { id: 301, title: "1. La hormona de los abrazos", start: "00:07:34", end: "00:32:44" },
                        { id: 302, title: "2. Los vínculos afectivos", start: "00:32:44", end: "00:44:05" },
                        { id: 303, title: "3. La empatía como herramienta", start: "00:44:05", end: "00:53:56" },
                        { id: 304, title: "4. Hombres y Testosterona", start: "00:53:56", end: "01:07:05" },
                        { id: 305, title: "5. Diferencias en mujeres", start: "01:07:05", end: "01:24:21" },
                        { id: 306, title: "6. Tocarse es necesario", start: "01:24:21", end: "01:33:33" },
                        { id: 307, title: "7. La oxitocina sorprende", start: "01:33:33", end: "01:53:23" },
                        { id: 308, title: "8. No es bueno estar solo", start: "01:53:23", end: "02:01:56" }
                    ]},
                    { title: "El Apego", items: [
                        { id: 309, title: "9. Qué es el apego", start: "02:01:56", end: "02:30:01" },
                        { id: 310, title: "10. Amamos como nos amaron", start: "02:30:01", end: "02:40:15" },
                        { id: 311, title: "11. La confusión en la educación", start: "02:40:15", end: "03:10:09" },
                        { id: 312, title: "12. El maltrato que más perjudica", start: "03:10:09", end: "03:54:02" },
                        { id: 313, title: "13. Cómo sanar las heridas", start: "03:54:02", end: "04:42:57" },
                        { id: 314, title: "14. El placer y el amor", start: "04:42:57", end: "05:31:17" },
                        { id: 315, title: "15. Hablemos del amor", start: "05:31:17", end: "05:51:23" },
                        { id: 316, title: "16. Elegir bien es un éxito", start: "05:51:23", end: "06:05:51" },
                        { id: 317, title: "17. La teoría de la pirámide", start: "06:05:51", end: "06:28:19" },
                        { id: 318, title: "18. Mejorar el éxito en una relación", start: "06:28:19", end: "06:44:26" },
                        { id: 319, title: "19. Personalidad altamente sensible", start: "06:44:26", end: "06:54:09" }
                    ]},
                    { title: "Personas Tóxicas", items: [
                        { id: 320, title: "20. Qué es una persona tóxica", start: "06:54:09", end: "07:05:47" },
                        { id: 321, title: "21. Identificar personas que no convienen", start: "07:05:47", end: "07:23:56" },
                        { id: 322, title: "22. Saber gestionar personas tóxicas", start: "07:23:56", end: "07:58:14" },
                        { id: 323, title: "Personas Vitamina (Fin)", start: "07:58:14", end: "08:08:41" }
                    ]}
                ]
            },
            pensarDemasiado: { 
                title: "Cómo dejar de pensar demasiado", 
                author: "Gilmer Contreras Berrospi", 
                color: "#8b5cf6", 
                videoId: "AtOez0u6PvY", 
                quotes: ["El sobrepensar es un ladrón de la tranquilidad.", "La paz mental es un derecho.", "No eres tus pensamientos.", "Deja ir lo que no puedes controlar."], 
                sections: [
                    { title: "Parte 1: Causas", items: [
                        { id: 500, title: "Introducción: Calma en un mundo ruidoso", start: "00:00:04", end: "00:03:16" },
                        { id: 501, title: "C1: El silencioso ladrón de la paz", start: "00:03:16", end: "00:13:16" },
                        { id: 502, title: "C2: El precio de la mente acelerada", start: "00:13:16", end: "00:24:08" },
                        { id: 503, title: "C3: Los orígenes del torbellino mental", start: "00:24:08", end: "00:35:00" },
                        { id: 504, title: "C4: Neurociencia de la sobrecarga cerebral", start: "00:35:00", end: "00:44:13" },
                        { id: 505, title: "C5: El ciclo vicioso del pensamiento negativo", start: "00:44:13", end: "00:54:18" }
                    ]},
                    { title: "Parte 2: Tácticas Mentales", items: [
                        { id: 506, title: "C6: El poder del aquí y ahora (Mindfulness)", start: "00:54:18", end: "01:08:01" },
                        { id: 507, title: "C7: Desactivando el piloto automático", start: "01:08:01", end: "01:18:50" },
                        { id: 508, title: "C8: Reestructuración cognitiva", start: "01:18:50", end: "01:29:32" },
                        { id: 509, title: "C9: El arte de la distancia cognitiva", start: "01:29:32", end: "01:36:58" },
                        { id: 510, title: "C10: La gratitud como antídoto", start: "01:36:58", end: "01:44:38" },
                        { id: 511, title: "C11: Estableciendo límites digitales", start: "01:44:38", end: "01:52:37" },
                        { id: 512, title: "C12: El arte de soltar lo incontrolable", start: "01:52:37", end: "02:00:10" }
                    ]},
                    { title: "Parte 3: Gestión y Sanación", items: [
                        { id: 513, title: "C13: Resolución de problemas efectiva", start: "02:00:10", end: "02:07:13" },
                        { id: 514, title: "C14: Comunicación consciente", start: "02:07:13", end: "02:14:35" },
                        { id: 515, title: "C15: La importancia del NO", start: "02:14:35", end: "02:22:03" },
                        { id: 516, title: "C16: Comprendiendo la depresión y ansiedad", start: "02:22:03", end: "02:30:52" },
                        { id: 517, title: "C17: Activación conductual", start: "02:30:52", end: "02:38:44" },
                        { id: 518, title: "C18: Desafiando el crítico interno", start: "02:38:44", end: "02:46:03" },
                        { id: 519, title: "C19: Empatía y autocompasión", start: "02:46:03", end: "02:54:15" }
                    ]},
                    { title: "Parte 4: Propósito y Cierre", items: [
                        { id: 520, title: "C20: Reconectando con el placer", start: "02:54:15", end: "03:01:52" },
                        { id: 521, title: "C21: Construyendo resiliencia", start: "03:01:52", end: "03:10:04" },
                        { id: 522, title: "C22: Entorno seguro", start: "03:10:04", end: "03:17:45" },
                        { id: 523, title: "C23: Hábitos de sueño", start: "03:17:45", end: "03:25:30" },
                        { id: 524, title: "C24: Nutrición mental", start: "03:25:30", end: "03:33:22" },
                        { id: 525, title: "C25: El valor de un propósito", start: "03:33:22", end: "03:41:05" },
                        { id: 526, title: "C26: Conexión social", start: "03:41:05", end: "03:48:40" },
                        { id: 527, title: "C27: Mente creativa", start: "03:48:40", end: "03:55:10" },
                        { id: 528, title: "C28: Disciplina vs Libertad", start: "03:55:10", end: "04:02:20" },
                        { id: 529, title: "C29: Perspectiva a largo plazo", start: "04:02:20", end: "04:09:13" },
                        { id: 530, title: "C30: Tu plan de compromiso", start: "04:09:13", end: "04:16:41" }
                    ]}
                ]
            }
        };

        let currentBookId = localStorage.getItem('activeBookId') || 'habitosAtomicos';
        let listeningHistory = JSON.parse(localStorage.getItem('listeningHistory')) || []; 
        let chapterNotes = JSON.parse(localStorage.getItem('chapterNotes')) || {}; 
        let favorites = JSON.parse(localStorage.getItem('favorites')) || []; 
        let actionPlan = JSON.parse(localStorage.getItem('actionPlan')) || [];
        let dailyGoalMinutes = parseInt(localStorage.getItem('dailyGoalMinutes')) || 30;
        let activeNoteId = null;
        let activeChartFilter = 'week';
        let countdownInterval = null;
        let activePlayback = null; // Para seguimiento automático

        function safeSet(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }

        function switchView(viewName) {
            ['library', 'notes', 'stats'].forEach(v => {
                const el = document.getElementById(`view-${v}`);
                const tab = document.getElementById(`tab-${v}`);
                if(el) el.classList.add('hidden');
                if(tab) tab.classList.remove('active');
            });
            const vEl = document.getElementById(`view-${viewName}`);
            const tEl = document.getElementById(`tab-${viewName}`);
            if(vEl) vEl.classList.remove('hidden');
            if(tEl) tEl.classList.add('active');
            
            updateQuoteWidget(); // Actualizar frase al cambiar pestaña
            
            if(viewName === 'stats') { renderStats(); renderHeatmap(); renderChart(activeChartFilter); renderHistoryLog(); }
            if(viewName === 'notes') renderAllNotes();
            if(viewName === 'library') { renderLibraryList(); renderActionPlan(); }
        }

        function switchBook(bookId) {
            if (!library[bookId]) bookId = 'habitosAtomicos';
            currentBookId = bookId; localStorage.setItem('activeBookId', bookId);
            document.querySelectorAll('.book-select-btn').forEach(btn => {
                btn.classList.remove('bg-amber-500', 'text-white');
                btn.classList.add('bg-white', 'dark:bg-slate-900', 'text-slate-600', 'dark:text-slate-400');
            });
            const activeBtn = document.getElementById(`book-btn-${bookId}`);
            if(activeBtn) { activeBtn.classList.remove('bg-white', 'dark:bg-slate-900'); activeBtn.classList.add('bg-amber-500', 'text-white'); }
            safeSet('book-title-display', library[bookId].title);
            const authorEl = document.getElementById('book-author-display')?.querySelector('span');
            if(authorEl) authorEl.innerText = library[bookId].author;
            
            updateQuoteWidget(); // Actualizar frase al cambiar libro
            renderLibraryList();
        }

        function updateQuoteWidget() {
            const book = library[currentBookId];
            const quotes = book.quotes;
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            const el = document.getElementById('header-quote-text');
            if(el) {
                el.style.opacity = '0';
                setTimeout(() => {
                    // Cambio: Agregamos el autor a la frase
                    el.innerText = `"${randomQuote}" — ${book.author}`;
                    el.style.opacity = '1';
                }, 300);
            }
        }

        function toggleComplete(id, title, start, end, e) {
            if(e) e.stopPropagation();
            const dur = parseTimeStr(end) - parseTimeStr(start);
            const idx = listeningHistory.findIndex(l => l.sectionId === id && l.bookId === currentBookId);
            if (idx > -1) listeningHistory.splice(idx, 1);
            else { listeningHistory.push({ timestamp: Date.now(), duration: dur, bookId: currentBookId, sectionId: id, title: title }); triggerConfetti(); }
            localStorage.setItem('listeningHistory', JSON.stringify(listeningHistory));
            renderLibraryList(); updateGlobalProgress();
        }

        // Función para autocompletar sin interacción
        function autoComplete(data) {
            if (!data) return;
            const { id, title, start, end } = data;
            const isAlreadyDone = listeningHistory.some(l => l.sectionId === id && l.bookId === currentBookId);
            if (!isAlreadyDone) {
                const dur = parseTimeStr(end) - parseTimeStr(start);
                listeningHistory.push({ timestamp: Date.now(), duration: dur, bookId: currentBookId, sectionId: id, title: title });
                localStorage.setItem('listeningHistory', JSON.stringify(listeningHistory));
                renderLibraryList(); updateGlobalProgress();
                triggerConfetti();
                // Notificación visual opcional
                const notif = document.createElement('div');
                notif.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg text-sm font-bold fade-in z-50';
                notif.innerText = '¡Capítulo completado!';
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 3000);
            }
        }

        function toggleFavorite(id, e) {
            if(e) e.stopPropagation();
            const key = `${currentBookId}_${id}`;
            const idx = favorites.indexOf(key);
            if(idx > -1) favorites.splice(idx, 1); else favorites.push(key);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            renderLibraryList();
        }

        function renderLibraryList() {
            const container = document.getElementById('app-container'), book = library[currentBookId], search = (document.getElementById('chapter-search')?.value || "").toLowerCase();
            if(!container) return; container.innerHTML = ''; let firstUnc = false, bookComp = 0, bookTotal = 0;
            const completedIds = listeningHistory.filter(l => l.bookId === currentBookId).map(l => l.sectionId);

            book.sections.forEach(sec => {
                const filtered = sec.items.filter(i => i.title.toLowerCase().includes(search));
                if(filtered.length === 0 && search) return;
                const secEl = document.createElement('div');
                secEl.innerHTML = `<h3 class="text-xs font-black text-slate-400 uppercase mb-2 ml-1 tracking-tighter">${sec.title}</h3><div class="bg-white dark:bg-slate-900 rounded-xl border dark:border-slate-800 overflow-hidden shadow-sm"></div>`;
                const list = secEl.querySelector('div');
                sec.items.forEach(item => {
                    if(search && !item.title.toLowerCase().includes(search)) return;
                    const done = completedIds.includes(item.id), dur = parseTimeStr(item.end) - parseTimeStr(item.start);
                    bookTotal += dur; if(done) bookComp += dur;
                    const next = !done && !firstUnc; if(next) firstUnc = true;
                    const isFav = favorites.includes(`${currentBookId}_${item.id}`);
                    const itemEl = document.createElement('div');
                    itemEl.className = `item-row group flex items-center justify-between p-3 border-b dark:border-slate-800 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-800/50 ${done ? 'bg-slate-50/50 dark:bg-slate-950/50' : ''} ${next ? 'next-up' : ''}`;
                    // Pasamos ID y Titulo a openVideo
                    itemEl.innerHTML = `<div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="toggleComplete(${item.id}, '${item.title}', '${item.start}', '${item.end}', event)">
                        <button class="check-btn ${done ? 'completed' : ''}"><i data-lucide="circle" class="w-5 h-5 icon-circle"></i><i data-lucide="check-circle" class="w-5 h-5 icon-check"></i></button>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-0.5"><span class="next-badge text-[9px] font-black text-amber-600 bg-amber-100 px-1 rounded uppercase tracking-tighter">Siguiente</span><p class="text-sm ${done ? 'line-through text-slate-400 font-normal' : 'font-bold text-slate-800 dark:text-slate-200'} leading-tight">${item.title}</p></div>
                            <div class="text-[10px] text-slate-400 font-mono flex gap-2"><i data-lucide="clock" class="w-3 h-3"></i> ${formatDuration(dur)} ${chapterNotes[`${currentBookId}_${item.id}`] ? '• Nota guardada' : ''}</div>
                        </div></div>
                        <div class="flex items-center gap-1">
                            <button onclick="toggleFavorite(${item.id}, event)" class="p-2 ${isFav ? 'text-amber-500' : 'text-slate-300'}"><i data-lucide="star" class="w-4 h-4 ${isFav ? 'fill-current' : ''}"></i></button>
                            <button onclick="openNotes(${item.id}, '${item.title}')" class="p-2 text-slate-300 hover:text-amber-500 transition-colors"><i data-lucide="pen-tool" class="w-4 h-4"></i></button>
                            <button onclick="openVideo(${item.id}, '${item.title}', '${item.start}', '${item.end}', '${item.videoId||''}')" class="p-2 bg-slate-100 dark:bg-slate-800 text-slate-500 rounded-full hover:bg-amber-500 hover:text-white transition-all"><i data-lucide="play" class="w-3 h-3 fill-current ml-0.5"></i></button>
                        </div>`;
                    list.appendChild(itemEl);
                });
                if(list.children.length > 0) container.appendChild(secEl);
            });
            const progressPct = bookTotal > 0 ? Math.round((bookComp / bookTotal) * 100) : 0;
            safeSet('book-progress-text', `${progressPct}%`);
            const bar = document.getElementById('book-inner-progress'); if(bar) bar.style.width = progressPct + '%';
            safeSet('book-time-text', `${formatDuration(bookComp)} / ${formatDuration(bookTotal)}`);
            updateGlobalProgress(); lucide.createIcons();
        }

        function renderStats() {
            const todayStart = new Date().setHours(0,0,0,0);
            let todaySec = 0, totalSec = 0; const actMap = {};
            listeningHistory.forEach(l => {
                totalSec += l.duration || 0;
                const dK = new Date(l.timestamp).toISOString().split('T')[0]; actMap[dK] = (actMap[dK] || 0) + l.duration;
                if(l.timestamp >= todayStart) todaySec += l.duration;
            });
            safeSet('stat-today', todaySec < 60 ? todaySec + 's' : formatDuration(todaySec));
            safeSet('stat-total-time', formatDuration(totalSec));
            safeSet('stat-level', totalSec > 36000 ? "Sabio" : totalSec > 18000 ? "Erudito" : "Novato");
            
            let streak = 0; let check = new Date();
            while(actMap[check.toISOString().split('T')[0]]) { streak++; check.setDate(check.getDate() - 1); }
            safeSet('stat-streak', streak + " d");
            
            lucide.createIcons();
        }

        function updateChartFilter(filter) {
            activeChartFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('bg-amber-500', 'text-white');
                b.classList.add('text-slate-500');
            });
            const btn = document.getElementById(`filter-${filter}`);
            if(btn) { btn.classList.remove('text-slate-500'); btn.classList.add('bg-amber-500', 'text-white'); }
            renderChart(filter);
        }

        function renderChart(filter) {
            const container = document.getElementById('stats-chart-container');
            if(!container) return; container.innerHTML = '';
            
            const data = [];
            const now = new Date();
            
            // Lógica de filtrado
            if (filter === 'week') {
                for(let i=6; i>=0; i--) {
                    const d = new Date(now); d.setDate(d.getDate() - i);
                    const k = d.toISOString().split('T')[0];
                    const val = listeningHistory.filter(l => new Date(l.timestamp).toISOString().split('T')[0] === k).reduce((acc, curr) => acc + curr.duration, 0);
                    data.push({ label: d.toLocaleDateString('es', {weekday:'short'}).slice(0,2), value: val });
                }
            } else if (filter === 'month') {
                // Últimos 30 días, agrupados cada 3 días para que quepan
                 for(let i=29; i>=0; i-=3) {
                     let groupVal = 0;
                     const labelDate = new Date(now); labelDate.setDate(labelDate.getDate() - i);
                     for(let j=0; j<3; j++) {
                         const d = new Date(now); d.setDate(d.getDate() - (i-j));
                         const k = d.toISOString().split('T')[0];
                         groupVal += listeningHistory.filter(l => new Date(l.timestamp).toISOString().split('T')[0] === k).reduce((acc, curr) => acc + curr.duration, 0);
                     }
                    data.push({ label: labelDate.getDate(), value: groupVal });
                }
            } else if (filter === 'year') {
                for(let i=11; i>=0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const val = listeningHistory.filter(l => {
                        const lDate = new Date(l.timestamp);
                        return lDate.getMonth() === d.getMonth() && lDate.getFullYear() === d.getFullYear();
                    }).reduce((acc, curr) => acc + curr.duration, 0);
                    data.push({ label: d.toLocaleDateString('es', {month:'narrow'}), value: val });
                }
            }

            const maxVal = Math.max(...data.map(d => d.value), 60); // Min 1 min para escala
            
            data.forEach(d => {
                const heightPct = Math.max(5, (d.value / maxVal) * 100);
                const barHtml = `
                    <div class="bar-container w-full">
                        <div class="bar-fill ${d.value > 0 ? 'bg-amber-400' : 'bg-slate-200 dark:bg-slate-800'}" style="height: ${heightPct}%;" title="${formatDuration(d.value)}"></div>
                        <span class="text-[9px] uppercase text-slate-400 font-bold">${d.label}</span>
                    </div>
                `;
                container.innerHTML += barHtml;
            });
        }

        function renderHistoryLog() {
            const container = document.getElementById('detailed-history-list');
            if(!container) return; container.innerHTML = '';
            
            if(listeningHistory.length === 0) {
                container.innerHTML = '<p class="text-xs text-slate-400 text-center py-6 italic">No hay historial aún.</p>';
                return;
            }

            // Agrupar por Mes/Año
            const grouped = {};
            const sortedHistory = [...listeningHistory].sort((a,b) => b.timestamp - a.timestamp);
            
            sortedHistory.forEach(h => {
                const date = new Date(h.timestamp);
                const monthKey = date.toLocaleDateString('es', { month: 'long', year: 'numeric' });
                if(!grouped[monthKey]) grouped[monthKey] = [];
                grouped[monthKey].push(h);
            });

            Object.keys(grouped).forEach(key => {
                const monthDiv = document.createElement('div');
                const monthHeader = `<div class="bg-slate-100 dark:bg-slate-900 px-4 py-2 text-[10px] font-black uppercase text-slate-500 tracking-wider sticky top-0">${key}</div>`;
                let itemsHtml = '';
                grouped[key].forEach(item => {
                    const d = new Date(item.timestamp);
                    const day = d.getDate();
                    const bookName = library[item.bookId] ? library[item.bookId].title : 'Desconocido';
                    itemsHtml += `
                        <div class="px-4 py-3 flex items-start gap-3 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                            <div class="flex flex-col items-center min-w-[30px]">
                                <span class="text-lg font-black text-slate-300 dark:text-slate-600 leading-none">${day}</span>
                                <span class="text-[9px] text-slate-400 uppercase">${d.toLocaleDateString('es',{weekday:'short'}).slice(0,3)}</span>
                            </div>
                            <div class="flex-1">
                                <p class="text-xs font-bold text-slate-800 dark:text-slate-200">${item.title}</p>
                                <p class="text-[10px] text-amber-600 dark:text-amber-500 font-medium truncate">${bookName}</p>
                            </div>
                             <span class="text-[10px] font-mono text-slate-400 bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded">${formatDuration(item.duration)}</span>
                        </div>
                    `;
                });
                monthDiv.innerHTML = monthHeader + itemsHtml;
                container.appendChild(monthDiv);
            });
        }

        // Nueva función renderHeatmap tipo Calendario
        function renderHeatmap() {
            const container = document.getElementById('streak-heatmap');
            if (!container) return;
            container.innerHTML = '';
            
            // Map de actividad
            const actMap = {}; 
            listeningHistory.forEach(l => { 
                const k = new Date(l.timestamp).toISOString().split('T')[0]; 
                actMap[k] = (actMap[k] || 0) + l.duration; 
            });

            const now = new Date();
            // Mostrar últimos 4 meses
            const monthsToShow = 4;
            
            for (let i = monthsToShow - 1; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = d.toLocaleDateString('es', { month: 'long' });
                const year = d.getFullYear();
                const daysInMonth = new Date(year, d.getMonth() + 1, 0).getDate();
                const startDay = new Date(year, d.getMonth(), 1).getDay(); // 0 is Sunday
                
                // Contenedor Mes
                const monthDiv = document.createElement('div');
                monthDiv.className = 'flex flex-col gap-2';
                
                // Header Mes
                const header = document.createElement('h4');
                header.className = 'text-[10px] font-bold uppercase text-slate-400 text-center tracking-wider';
                header.innerText = monthName;
                monthDiv.appendChild(header);
                
                // Grid Calendario (7 cols)
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-7 gap-1';
                
                // Relleno días vacíos al inicio (asumiendo Domingo inicio semana)
                for (let j = 0; j < startDay; j++) {
                    const empty = document.createElement('div');
                    empty.className = 'w-3 h-3'; // Placeholder
                    grid.appendChild(empty);
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    // Crear fecha local segura para evitar saltos de zona horaria
                    const localDate = new Date(year, d.getMonth(), day, 12, 0, 0);
                    const dateStr = localDate.toISOString().split('T')[0];
                    const v = actMap[dateStr] || 0;
                    
                    const cell = document.createElement('div');
                    cell.title = `${day} ${monthName}: ${Math.round(v/60)} min`;
                    
                    let bgClass = 'bg-slate-100 dark:bg-slate-800';
                    if (v > 0) bgClass = 'bg-amber-200';
                    if (v > 900) bgClass = 'bg-amber-300'; // > 15 min
                    if (v > 1800) bgClass = 'bg-amber-400'; // > 30 min
                    if (v > 3600) bgClass = 'bg-amber-500'; // > 1 hora
                    
                    cell.className = `w-3 h-3 rounded-sm transition-colors ${bgClass}`;
                    grid.appendChild(cell);
                }
                
                monthDiv.appendChild(grid);
                container.appendChild(monthDiv);
            }
        }

        function renderAllNotes(onlyFavs = false) {
            const container = document.getElementById('all-notes-container'); if(!container) return; container.innerHTML = '';
            const grouped = {};
            Object.keys(chapterNotes).forEach(k => { 
                const [b, s] = k.split('_'); if(onlyFavs && !favorites.includes(k)) return;
                if(!grouped[b]) grouped[b] = []; grouped[b].push({s, t: chapterNotes[k], isFav: favorites.includes(k)}); 
            });
            if(Object.keys(grouped).length === 0) { container.innerHTML = '<p class="text-slate-400 italic text-center py-10">Sin notas aún.</p>'; return; }
            Object.keys(grouped).forEach(b => {
                if(!library[b]) return;
                const el = document.createElement('div'); el.className = 'bg-white dark:bg-slate-900 p-5 rounded-xl border dark:border-slate-800 mb-4 shadow-sm';
                let html = `<h3 class="font-bold border-b pb-2 mb-3 flex items-center gap-2 dark:text-white"><span class="w-3 h-3 rounded-full" style="background-color:${library[b].color}"></span>${library[b].title}</h3>`;
                grouped[b].forEach(n => {
                    let cT = "Capítulo"; Object.values(library[b].sections).forEach(s => { const i = s.items.find(x => x.id == n.s); if(i) cT = i.title; });
                    html += `<div class="mb-4 last:mb-0"><div class="flex items-center gap-2 mb-1"><h4 class="text-[10px] font-bold text-amber-600 uppercase tracking-widest">${cT}</h4>${n.isFav ? '<i data-lucide="star" class="w-3 h-3 text-amber-500 fill-current"></i>' : ''}</div><p class="text-sm text-slate-600 dark:text-slate-400 italic whitespace-pre-wrap bg-slate-50 dark:bg-slate-950 p-3 rounded-lg border-l-2 border-slate-200 dark:border-slate-800">"${n.t}"</p></div>`;
                });
                el.innerHTML = html; container.appendChild(el);
            });
            lucide.createIcons();
        }

        function renderActionPlan() {
            const list = document.getElementById('action-plan-list'); if(!list) return; list.innerHTML = actionPlan.length ? '' : '<p class="text-xs text-slate-400 italic font-medium text-center py-4">Aún no has definido tus pasos atómicos.</p>';
            actionPlan.forEach((it, i) => {
                const el = document.createElement('div'); el.className = 'flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-950 rounded-lg border dark:border-slate-800 shadow-sm';
                el.innerHTML = `<div class="flex gap-3 items-center"><input type="checkbox" ${it.done?'checked':''} onchange="toggleAction(${i})" class="accent-amber-500 w-4 h-4 rounded"><span class="text-sm ${it.done?'line-through opacity-50 dark:text-slate-500 text-slate-400 font-normal':'text-slate-700 dark:text-slate-300 font-bold'}">${it.text}</span></div><button onclick="removeAction(${i})" class="text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                list.appendChild(el);
            });
            lucide.createIcons();
        }

        function addActionItem() { const input = document.getElementById('new-action-input'); if(!input.value.trim()) return; actionPlan.push({text: input.value, done: false}); localStorage.setItem('actionPlan', JSON.stringify(actionPlan)); input.value = ''; renderActionPlan(); }
        function toggleAction(i) { actionPlan[i].done = !actionPlan[i].done; localStorage.setItem('actionPlan', JSON.stringify(actionPlan)); renderActionPlan(); if(actionPlan[i].done) triggerConfetti(); }
        function removeAction(i) { actionPlan.splice(i, 1); localStorage.setItem('actionPlan', JSON.stringify(actionPlan)); renderActionPlan(); }
        
        function resetCurrentBook() { 
            if(confirm("¿Estás 100% seguro de que quieres borrar todo el progreso de este audiolibro? Todos los checks del libro seleccionado serán eliminados permanentemente.")) {
                listeningHistory = listeningHistory.filter(l => l.bookId !== currentBookId);
                localStorage.setItem('listeningHistory', JSON.stringify(listeningHistory));
                renderLibraryList();
                updateGlobalProgress();
                alert("Progreso del libro reiniciado exitosamente.");
            }
        }

        function parseTimeStr(t) { const p = t.split(':').map(Number); return p.length === 3 ? p[0]*3600 + p[1]*60 + p[2] : p[0]*60 + p[1]; }
        function formatDuration(s) { const h = Math.floor(s/3600), m = Math.floor((s%3600)/60); return h > 0 ? `${h}h ${m}m` : `${m} min`; }
        function loadRandomQuote() { 
            // Fallback inicial
            updateQuoteWidget();
        }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); }
        function triggerConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
        
        function openVideo(id, title, s, e, v) { 
            const start = parseTimeStr(s), end = parseTimeStr(e), vidId = v || library[currentBookId].videoId; 
            document.getElementById('youtube-iframe').src = `https://www.youtube.com/embed/${vidId}?start=${start}&end=${end}&autoplay=1&rel=0`; 
            document.getElementById('video-modal').classList.remove('hidden'); 
            
            // Set active playback for auto-complete
            activePlayback = { id: id, title: title, start: s, end: e };
            startCountdown(end - start);
        }

        function startCountdown(seconds) {
            if(countdownInterval) clearInterval(countdownInterval);
            let rem = seconds; updateCountdownUI(rem);
            countdownInterval = setInterval(() => { 
                rem--; 
                if(rem <= 0) { 
                    clearInterval(countdownInterval); 
                    const playbackData = activePlayback; // Guardar datos antes de que se borren
                    closeVideo(); 
                    autoComplete(playbackData); // Trigger auto-complete con los datos guardados
                } 
                updateCountdownUI(rem); 
            }, 1000);
        }

        function updateCountdownUI(sec) {
            const m = Math.floor(sec/60), s = sec%60;
            const text = `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
            const el = document.getElementById('playback-countdown'); if(el) el.innerText = text;
        }

        function closeVideo() { 
            document.getElementById('youtube-iframe').src = ""; 
            document.getElementById('video-modal').classList.add('hidden'); 
            if(countdownInterval) clearInterval(countdownInterval); 
            activePlayback = null;
        }
        function openNotes(id, title) { activeNoteId = `${currentBookId}_${id}`; safeSet('note-chapter-title', title); document.getElementById('note-textarea').value = chapterNotes[activeNoteId] || ""; document.getElementById('notes-modal').classList.remove('hidden'); }
        function saveNote() { const v = document.getElementById('note-textarea').value; if(v.trim()) chapterNotes[activeNoteId] = v; else delete chapterNotes[activeNoteId]; localStorage.setItem('chapterNotes', JSON.stringify(chapterNotes)); closeNotes(); renderLibraryList(); }
        function closeNotes() { document.getElementById('notes-modal').classList.add('hidden'); activeNoteId = null; }
        function showStats() { switchView('stats'); }
        function adjustDailyGoal(a) { dailyGoalMinutes = Math.max(5, dailyGoalMinutes + a); localStorage.setItem('dailyGoalMinutes', dailyGoalMinutes); renderStats(); }
        
        function updateGlobalProgress() { 
            let total = 0; Object.values(library).forEach(b => b.sections.forEach(s => total += s.items.length));
            const bar = document.getElementById('global-progress-bar'); if(bar) bar.style.width = (Math.round((listeningHistory.length / total) * 100) || 0) + '%';
        }

        function exportData() { const d = {history: listeningHistory, notes: chapterNotes, plan: actionPlan, favs: favorites, goal: dailyGoalMinutes}; const blob = new Blob([JSON.stringify(d)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'audiolibro_progreso.json'; a.click(); }
        function triggerImport() { document.getElementById('import-file').click(); }
        function handleFileImport(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader(); reader.onload = (ev) => {
                try {
                    const imp = JSON.parse(ev.target.result);
                    if(imp.history) listeningHistory = [...new Map([...listeningHistory, ...imp.history].map(i => [i.bookId+i.sectionId, i])).values()];
                    if(imp.notes) Object.assign(chapterNotes, imp.notes);
                    if(imp.plan) actionPlan = imp.plan;
                    if(imp.favs) favorites = imp.favs;
                    localStorage.setItem('listeningHistory', JSON.stringify(listeningHistory)); localStorage.setItem('chapterNotes', JSON.stringify(chapterNotes)); localStorage.setItem('actionPlan', JSON.stringify(actionPlan)); localStorage.setItem('favorites', JSON.stringify(favorites));
                    switchBook(currentBookId); alert("Importación exitosa."); triggerConfetti();
                } catch(err) { alert("Archivo inválido."); }
            }; reader.readAsText(file);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            const stored = localStorage.getItem('activeBookId'); if(stored && library[stored]) currentBookId = stored;
            switchBook(currentBookId);
            updateChartFilter('week'); // Init chart
        });
    </script>
</body>
</html>
